

% I have no idea what has changed since when we didn't need this fudge factor,
% but for some reason, either the types or the grid graphics have shifted by a millimeter or so:
\newcommand{\mkts@GridVerticalFudgeFactor}{2}


% ==========================================================================================================
% Page Layout
% ----------------------------------------------------------------------------------------------------------
\usepackage{geometry}
\usepackage{tikz}
\usepackage{eso-pic}
\usepackage{multicol}

% \pgfdeclarelayer{mktsTikzLayerA}
% \pgfdeclarelayer{mktsTikzLayerB}
% \pgfdeclarelayer{mktsTikzLayerC}
% \pgfdeclarelayer{mktsTikzLayerX}
% \pgfdeclarelayer{mktsTikzLayerY}
% \pgfdeclarelayer{mktsTikzLayerZ}
% \pgfsetlayers{%
%   mktsTikzLayerA,%
%   mktsTikzLayerB,%
%   mktsTikzLayerB,%
%   main,%
%   mktsTikzLayerX,%
%   mktsTikzLayerY,%
%   mktsTikzLayerZ}

% ----------------------------------------------------------------------------------------------------------
\makeatletter%

% ----------------------------------------------------------------------------------------------------------
\DeclareOption{null}{%
  }

% ----------------------------------------------------------------------------------------------------------
\DeclareOption{default}{%
  }

% ----------------------------------------------------------------------------------------------------------
\DeclareOption{a4}{%
  \typeout{mkts-page-geometry: \trmIndigo{a4}}
  \setlength{\columnsep}{5mm}%
  \setlength{\columnseprule}{0.155mm}%
  \geometry{
    % asymmetric,% see http://tex.stackexchange.com/a/42051/28067
    driver=xetex,
    % showframe,%
    % twoside,
    left=21mm,%
    right=21mm,%
    top=18mm,%
    bottom=11.5mm,%
    headsep=5mm,%
    headheight=5mm,%
    footskip=5mm,%
    marginparsep=0mm,%
    marginparwidth=0mm,%
    includehead=true,%
    includefoot=true,%
    includemp=false,%
    % paperwidth=148mm,%
    % paperheight=210mm,%
    paperwidth=210mm,%
    paperheight=297mm,%
    }%
  }

% ----------------------------------------------------------------------------------------------------------
\DeclareOption{frame}{%
  \geometry{showframe}%
  }

% ----------------------------------------------------------------------------------------------------------
\newdimen\mkts@GridYmax%
\newdimen\mkts@GridXshift%
\newdimen\mkts@GridXright%
\newdimen\mkts@GridYshift%
\newdimen\mkts@GridX%
\newdimen\mkts@GridY%
\newdimen\mkts@TwoColumnsCenter%
\newdimen\mkts@TwoColumnsCenterLeft%
\newdimen\mkts@TwoColumnsCenterRight%
\newdimen\mkts@FourColumnsCenterOne%
\newdimen\mkts@FourColumnsCenterOneLeft%
\newdimen\mkts@FourColumnsCenterOneRight%
\newdimen\mkts@FourColumnsCenterTwo%
\newdimen\mkts@FourColumnsCenterTwoLeft%
\newdimen\mkts@FourColumnsCenterTwoRight%
\newdimen\mkts@ThreeColumnsCenterOne%
\newdimen\mkts@ThreeColumnsCenterOneLeft%
\newdimen\mkts@ThreeColumnsCenterOneRight%
\newdimen\mkts@ThreeColumnsCenterTwoLeft%
\newdimen\mkts@ThreeColumnsCenterTwoRight%

% ----------------------------------------------------------------------------------------------------------
\newcommand{\mkts@GridCalculateLengths}{
  \typeout{mkts-page-geometry: \trmIndigo{mkts@GridCalculateLengths}}
  \setlength{\mkts@GridYmax}{\paperheight - \headheight - \headsep - \topmargin - \voffset - 1in}%
  \setlength{\mkts@GridXshift}{\hoffset + 1in + \oddsidemargin}%
  \setlength{\mkts@GridXright}{\mkts@GridXshift + \textwidth}%
  % \setlength{\mkts@GridYshift}{\mkts@GridYmax - \textheight - 15mm }%
  % % ........................................................................................................
  % \setlength{\mkts@GridYmax}{\paperheight - \headheight - \headsep - \topmargin - \voffset - 1in}%
  % \setlength{\mkts@GridXshift}{\hoffset + 1in + \oddsidemargin}%
  \setlength{\mkts@GridYshift}{\mkts@GridYmax - \textheight}%
  % ........................................................................................................
  \setlength{\mkts@TwoColumnsCenter}{\textwidth * \real{0.5}}%
  \setlength{\mkts@TwoColumnsCenterLeft}{\mkts@TwoColumnsCenter - \columnsep * \real{0.5}}%
  \setlength{\mkts@TwoColumnsCenterRight}{\mkts@TwoColumnsCenterLeft + \columnsep}%
  % ........................................................................................................
  \setlength{\mkts@FourColumnsCenterOne}{\mkts@TwoColumnsCenterLeft * \real{0.5}}%
  \setlength{\mkts@FourColumnsCenterOneLeft}{\mkts@FourColumnsCenterOne - \columnsep * \real{0.5}}%
  \setlength{\mkts@FourColumnsCenterOneRight}{\mkts@FourColumnsCenterOneLeft + \columnsep}%
  % ........................................................................................................
  \setlength{\mkts@FourColumnsCenterTwo}{\mkts@FourColumnsCenterOne + \textwidth * \real{0.5} + \columnsep * \real{0.5}}%
  \setlength{\mkts@FourColumnsCenterTwoLeft}{\mkts@FourColumnsCenterTwo - \columnsep * \real{0.5}}%
  \setlength{\mkts@FourColumnsCenterTwoRight}{\mkts@FourColumnsCenterTwoLeft + \columnsep}%
  % ........................................................................................................
  \setlength{\mkts@ThreeColumnsCenterOne}{( \textwidth - \columnsep * \real{0.5} ) * \real{0.33333}}%
  \setlength{\mkts@ThreeColumnsCenterOneLeft}{\mkts@ThreeColumnsCenterOne - \columnsep * \real{0.5}}%
  \setlength{\mkts@ThreeColumnsCenterOneRight}{\mkts@ThreeColumnsCenterOneLeft + \columnsep}%
  % ........................................................................................................
  \setlength{\mkts@ThreeColumnsCenterTwoLeft}{\mkts@ThreeColumnsCenterOneRight + \mkts@ThreeColumnsCenterOneLeft}%
  \setlength{\mkts@ThreeColumnsCenterTwoRight}{\mkts@ThreeColumnsCenterTwoLeft + \columnsep}%
  }

% ----------------------------------------------------------------------------------------------------------
\DeclareOption{linebands}{%
  \typeout{mkts-page-geometry: \trmIndigo{linebands}}
  \mkts@GridCalculateLengths%
  % thx to http://tex.stackexchange.com/a/41153/28067
  \AddToShipoutPicture{%
    % \begin{pgfonlayer}{mktsTikzLayerZ}
    \begin{tikzpicture}[overlay,remember picture]%
      % ### TAINT should calculate number of lines ###
      \foreach \y in { 0, ..., 53 }{
        \setlength{\mkts@GridY}{\mkts@GridYshift + \y\mktsLineheight};
        \draw[ yellow!20, line width = \mktsFontsize * 0.9 ]
          ( \mkts@GridXshift, \mktsLineheight * 0.525 + \mkts@GridY ) -- ( \mkts@GridXright, \mktsLineheight * 0.525 + \mkts@GridY );
        }
    \end{tikzpicture}%
    % \end{pgfonlayer}
    }%
  }

% ----------------------------------------------------------------------------------------------------------
\DeclareOption{interbands}{%
  \typeout{mkts-page-geometry: \trmIndigo{descenders}}
  \mkts@GridCalculateLengths%
  % thx to http://tex.stackexchange.com/a/41153/28067
  \AddToShipoutPicture{%
    % \begin{pgfonlayer}{mktsTikzLayerZ}
    \begin{tikzpicture}[overlay,remember picture]%
      \draw[ red!40, line width = \mktsLineheight - \mktsFontsize, xshift = \mkts@GridXshift ]
        ( 0mm,
          \mkts@GridYmax - \textheight + \mktsLineheight * 0.5 )
        grid[ xstep = \textwidth, ystep = \mktsLineheight,
          yshift = -\mktsLineheight * 0.125 - \mktsFontsize * 0.385 ]
        ( \textwidth,
          \mkts@GridYmax );
    \end{tikzpicture}%
    % \end{pgfonlayer}
    }%
  }

% ----------------------------------------------------------------------------------------------------------
\DeclareOption{mmgrid}{%
  \typeout{mkts-page-geometry: \trmIndigo{mmgrid}}
  \mkts@GridCalculateLengths%
  % thx to http://tex.stackexchange.com/a/41153/28067
  \AddToShipoutPicture{%
    % \begin{pgfonlayer}{mktsTikzLayerZ}
    \begin{tikzpicture}[overlay,remember picture]%
      \draw[ red!25, line width = 0.1mm, xshift = \mkts@GridXshift ]
        ( 0mm,
          \mkts@GridYmax - \textheight + \mktsLineheight * 0.5 )
        grid[ xstep = 1mm, ystep = 1mm,
          yshift = \mktsLineheight * 0.05 ]
        ( \textwidth,
          \mkts@GridYmax );
    \end{tikzpicture}%
    % \end{pgfonlayer}
    }%
  }

% ----------------------------------------------------------------------------------------------------------
\DeclareOption{cmgrid}{%
  \typeout{mkts-page-geometry: \trmIndigo{mmgrid}}
  \mkts@GridCalculateLengths%
  % thx to http://tex.stackexchange.com/a/41153/28067
  \AddToShipoutPicture{%
    % \begin{pgfonlayer}{mktsTikzLayerZ}
    \begin{tikzpicture}[overlay,remember picture]%
      \draw[ red!25, line width = 0.2mm, xshift = \mkts@GridXshift ]
        ( 0mm,
          \mkts@GridYmax - \textheight + \mktsLineheight * 0.5 )
        grid[ xstep = 1cm, ystep = 1cm,
          yshift = \mktsLineheight * 0.05 - 1mm ]
        ( \textwidth,
          \mkts@GridYmax );
      \draw[ red!50, line width = 0.1mm, xshift = \mkts@GridXshift ]
        ( 0mm,
          \mkts@GridYmax - \textheight + \mktsLineheight * 0.5 )
        grid[ xstep = 5mm, ystep = 5mm,
          yshift = \mktsLineheight * 0.05 - 1mm ]
        ( \textwidth,
          \mkts@GridYmax );
    \end{tikzpicture}%
    % \end{pgfonlayer}
    }%
  }

% ----------------------------------------------------------------------------------------------------------
\DeclareOption{baselines}{%
  \typeout{mkts-page-geometry: \trmIndigo{baselines}}
  \mkts@GridCalculateLengths%
  % thx to http://tex.stackexchange.com/a/41153/28067
  \AddToShipoutPicture{%
    \begin{tikzpicture}[overlay,remember picture]%
      \draw[ red!30, thin, xshift = \mkts@GridXshift ]
      %\draw[red!30!white,thin]
        ( 0mm,
          \mkts@GridYmax - \textheight )
        grid[ xstep = \textwidth, ystep = \mktsLineheight,
          yshift = -\mktsLineheight * 0.125 * \mkts@GridVerticalFudgeFactor ]
          % yshift = -\mktsLineheight * 0.125 - 0.5mm ]
        ( \textwidth,
          \mkts@GridYmax );
    \end{tikzpicture}%
    }%
  }

% ----------------------------------------------------------------------------------------------------------
\DeclareOption{medians}{%
  \typeout{mkts-page-geometry: \trmIndigo{medians}}
  \mkts@GridCalculateLengths%
  % thx to http://tex.stackexchange.com/a/41153/28067
  \AddToShipoutPicture{%
    \begin{tikzpicture}[overlay,remember picture]%
      \draw[ green!50, thin, xshift = \mkts@GridXshift ]
        ( 0mm,
          \mkts@GridYmax - \textheight )
        grid[ xstep = \textwidth, ystep = \mktsLineheight,
          yshift = -\mktsLineheight * 0.125 + \mktsFontsize * 0.4 ]
        ( \textwidth,
          \mkts@GridYmax );
    \end{tikzpicture}%
    }%
  }

% ----------------------------------------------------------------------------------------------------------
\DeclareOption{ascenders}{%
  \typeout{mkts-page-geometry: \trmIndigo{ascenders}}
  \mkts@GridCalculateLengths%
  % thx to http://tex.stackexchange.com/a/41153/28067
  \AddToShipoutPicture{%
    \begin{tikzpicture}[overlay,remember picture]%
      \draw[ green!50, thin, xshift = \mkts@GridXshift ]
        ( 0mm,
          \mkts@GridYmax - \textheight )
        grid[ xstep = \textwidth, ystep = \mktsLineheight,
          yshift = -\mktsLineheight * 0.125 * \mkts@GridVerticalFudgeFactor + \mktsFontsize * 0.7 ]
        ( \textwidth,
          \mkts@GridYmax );
    \end{tikzpicture}%
    }%
  }

% ----------------------------------------------------------------------------------------------------------
\DeclareOption{descenders}{%
  \typeout{mkts-page-geometry: \trmIndigo{descenders}}
  \mkts@GridCalculateLengths%
  % thx to http://tex.stackexchange.com/a/41153/28067
  \AddToShipoutPicture{%
    % \begin{pgfonlayer}{mktsTikzLayerA}
    \begin{tikzpicture}[overlay,remember picture]%
      \draw[ green!50, thin, xshift = \mkts@GridXshift ]
        ( 0mm,
          \mkts@GridYmax - \textheight )
        grid[ xstep = \textwidth, ystep = \mktsLineheight,
          yshift = -\mktsLineheight * 0.125 * \mkts@GridVerticalFudgeFactor - \mktsFontsize * 0.25 ]
        ( \textwidth,
          \mkts@GridYmax );
    \end{tikzpicture}%
    % \end{pgfonlayer}
    }%
  }

% ----------------------------------------------------------------------------------------------------------
\DeclareOption{columns}{%
  \typeout{mkts-page-geometry: \trmIndigo{columns}}
  \mkts@GridCalculateLengths%
  % ........................................................................................................
  \AddToShipoutPicture{%
    \begin{tikzpicture}[ overlay, remember picture, blue!30, thin, xshift = \mkts@GridXshift, yshift = \mkts@GridYshift ]%
      % \draw ( \mkts@TwoColumnsCenterLeft,       \footheight + \footsep ) -- ( \mkts@TwoColumnsCenterLeft,        \textheight );
      \draw ( \mkts@TwoColumnsCenterLeft,       0mm ) -- ( \mkts@TwoColumnsCenterLeft,        \textheight );
      \draw ( \mkts@TwoColumnsCenterRight,      0mm ) -- ( \mkts@TwoColumnsCenterRight,       \textheight );
      \draw ( \mkts@FourColumnsCenterOneLeft,   0mm ) -- ( \mkts@FourColumnsCenterOneLeft,    \textheight );
      \draw ( \mkts@FourColumnsCenterOneRight,  0mm ) -- ( \mkts@FourColumnsCenterOneRight,   \textheight );
      \draw ( \mkts@FourColumnsCenterTwoLeft,   0mm ) -- ( \mkts@FourColumnsCenterTwoLeft,    \textheight );
      \draw ( \mkts@FourColumnsCenterTwoRight,  0mm ) -- ( \mkts@FourColumnsCenterTwoRight,   \textheight );
    \end{tikzpicture}%
    \begin{tikzpicture}[ overlay, remember picture, green!60, thin, xshift = \mkts@GridXshift, yshift = \mkts@GridYshift ]%
      \draw ( \mkts@ThreeColumnsCenterOneLeft,  0mm ) -- ( \mkts@ThreeColumnsCenterOneLeft,   \textheight );
      \draw ( \mkts@ThreeColumnsCenterOneRight, 0mm ) -- ( \mkts@ThreeColumnsCenterOneRight,  \textheight );
      \draw ( \mkts@ThreeColumnsCenterTwoLeft,  0mm ) -- ( \mkts@ThreeColumnsCenterTwoLeft,   \textheight );
      \draw ( \mkts@ThreeColumnsCenterTwoRight, 0mm ) -- ( \mkts@ThreeColumnsCenterTwoRight,  \textheight );
    \end{tikzpicture}%
    }%
  }

% ----------------------------------------------------------------------------------------------------------
\makeatother%

% ----------------------------------------------------------------------------------------------------------
\ExecuteOptions{default}
\ProcessOptions\relax


