

% ==========================================================================================================
% Unicode and CJK Handling
% ----------------------------------------------------------------------------------------------------------
\usepackage{fontspec}
% \usepackage{/home/flow/own/tex-packages/xeCJK-2.4.6-r306/xeCJK}
% \usepackage{xeCJK}

% % Should fix CJK linebreaks as per http://tex.stackexchange.com/a/38276/28067
% % ### TAINT this setting should be made only available inside CJK text regions ###
% \XeTeXlinebreaklocale "ja"% for Japanese
% \XeTeXlinebreakskip 0pt plus 0.1pt% sets the skip

\usepackage{leading}
% \usepackage{/Volumes/Storage/io/jizura-xelatex/tex-inputs/utils}
% \usepackage{/Users/flow/JIZURA/flow/dictionary/tex-inputs/accentbx/accentbx}
\usepackage{cxltx-style-accentbox}
\usepackage{cxltx-style-trm}
% \usepackage{pbox}
% \usepackage{array}
% \let\footruleskip\undefined\usepackage{fancyhdr}
\usepackage{fixltx2e}
% \usepackage[usenames,dvipsnames,svgnames,table,x11names]{xcolor}
\usepackage[factor=1000]{microtype}
\usepackage{cxltx-style-base}
\usepackage{cxltx-style-trm}
% \usepackage{cxltx-style-accentbox}
\usepackage{cxltx-style-pushraise}
\usepackage{cxltx-style-hyphenation-tolerance}
\usepackage{cxltx-style-oddeven}
\usepackage{cxltx-style-position-absolute}
\usepackage{cxltx-style-pushraise}
\usepackage{cxltx-style-smashbox}

% ==========================================================================================================
% Page Layout
% ----------------------------------------------------------------------------------------------------------
\usepackage[
  % asymmetric,% see http://tex.stackexchange.com/a/42051/28067
  driver=xetex,
  % showframe,%
  % twoside,
  left=21mm,%
  right=21mm,%
  top=18mm,%
  bottom=11.5mm,%
  headsep=5mm,%
  headheight=5mm,%
  footskip=5mm,%
  marginparsep=0mm,%
  marginparwidth=0mm,%
  includehead=true,%
  includefoot=true,%
  includemp=false,%
  paperwidth=210mm,%
  paperheight=297mm,%
  ]{geometry}
% ..........................................................................................................
% \usepackage{pagegrid}\pagegridsetup{top-left,step=1mm,arrows=false}
% \pagegridsetup{top-left,step=4.6667mm,arrows=false}
% % \pagegridsetup{top-left,step=\myLineheight,arrows=false}
% % \pagegridsetup{top-left,step=7mm,arrows=false}


% ----------------------------------------------------------------------------------------------------------
% Footnotes
% ### TAINT this combination does increase font size and line spacing in
% footnotes, but the notes are still not run together, and the spacing
% between footnotes is too small. — Considering to use endnotes instead. ###
\usepackage[para,bottom,multiple]{footmisc}
\usepackage{setspace,etoolbox}% http://ctan.org/pkg/{setspace,etoolbox}
\makeatletter
\patchcmd{\@footnotetext}% <cmd>
  {\footnotesize}% <search>
  {\normalsize\setstretch{1}}% <replace>
  {}{}% <success><failure>
\makeatother

% ----------------------------------------------------------------------------------------------------------
\let\footruleskip\undefined\usepackage{fancyhdr}
\usepackage{fix2col}% Patch LaTeX's output routine to handle marks correctly with two columns
\pagestyle{fancy}
\renewcommand{\headrulewidth}{0mm}
\renewcommand{\footrulewidth}{0mm}
\fancyhead[OR]{\prPush{1.1}{\cn{{\mktsFontfileBiaukai{}萬字一覽置換索引}}}}
\fancyhead[EL]{\cn{{\mktsFontfileBiaukai{}萬字一覽置換索引}}}
% \fancyhead[EL,OR]{\leftmark}
% \fancyhead[OL,ER]{\rightmark\cn{{\mktsFontfileBiaukai{}字面萬字一覽}}}
\fancyfoot[OR]{\prPush{1.1}{\pageNr{\thepage}}}
\fancyfoot[EL]{\pageNr{\thepage}}
\fancyfoot[OC,EC]{}
\fancyfoot[OL,ER]{}

% ----------------------------------------------------------------------------------------------------------
\usepackage{multicol}
% \setlength{\multicolsep}{6.0pt plus 2.0pt minus 1.5pt}
\setlength{\multicolsep}{0mm plus 0mm minus 0mm}
\setlength{\columnsep}{5mm}
\setlength\columnseprule{0.155mm}


% ==========================================================================================================
% Nifty stuff
% ----------------------------------------------------------------------------------------------------------
% \usepackage{float}
% \usepackage{wrapfig}
% \usepackage{enumitem}
% \usepackage[protrusion=true,final]{/home/flow/own/tex-packages/microtype/microtype} % doesn't work yet
% \usepackage[protrusion=true,final]{microtype} % doesn't work yet
\newcommand{\mktsShowpar}{%
  \makebox[0mm]{\color{red!25}¶}}

\newcommand{\mktsInsertblankpage}{\thispagestyle{empty}\mbox{}\newpage}

% thx to http://tex.stackexchange.com/a/11709/28067
\newcommand*\mktsCleartoleftpage{%
  \clearpage
  \ifodd\value{page}\hbox{}\newpage\fi
}


% ----------------------------------------------------------------------------------------------------------
% fontsizes
\newdimen\myLineheight
\newdimen\myFontsize
% \myFontsize=3.5mm% too small
% \myFontsize=4.1667mm
% space between lines 4.6667mm - 3.8mm = 0.8667mm
\myFontsize=3.8mm
% now in fonts.sty:
% \renewcommand{\adjustJzrCjkIdeograph}[1]{\prRaise{-0.125}{\makebox[1.1053\myFontsize]{#1}}} % !!!
\myLineheight=4.6667mm
% \myLineheight=3.8mm % reduced to fontsize
\setlength{\baselineskip}{\myLineheight}
\setlength{\parskip}{0mm}
\setlength{\parindent}{0mm}
% thx to http://www.tug.org/TUGboat/tb28-1/tb88bazargan.pdf for the next:
\lineskiplimit=-10pt%
\lineskip=0pt%
\topskip=\baselineskip%

% ----------------------------------------------------------------------------------------------------------
% mkts Styles
% consider to put these into `.master.tex`
\newcommand{\mktsStyleBold}{%
  \renewcommand{\cn}[1]{{\adjustCjkIdeograph{\mktsFontfileCwtexqheibold##1}}}%
  \renewcommand{\ka}[1]{\adjustKatakana{\mktsFontfileCwtexqheibold##1}}%
  \renewcommand{\hi}[1]{\adjustHiragana{\mktsFontfileCwtexqheibold##1}}%
  \renewcommand{\hg}[1]{\adjustHangeul{\mktsFontfileCwtexqheibold##1}}%
  \fontsize{0.8\myFontsize}{0.8\myFontsize}\mktsFontfileUbuntub}

\newcommand{\mktsStyleItalic}{%
  \mktsFontfileEbgaramondtwelveitalic}

\newcommand{\mktsStyleSymbol}{%
  \mktsFontfileSunexta}

% ### TAINT need to add space before and after code ###
\newcommand{\mktsStyleCode}{%
  \fontsize{0.8\myFontsize}{0.8\myFontsize}%%
  \mktsFontfileSourcecodeproregular}

% ----------------------------------------------------------------------------------------------------------
% https://groups.google.com/d/msg/comp.text.tex/J2qcZxgcR5M/3HyPquEDkcgJ
% obeyalllines is like obeylines, excepts it also keeps blank lines
\def\mktsMakeActive#1{\catcode`#113\relax}

\def\mktsAdjustedPar{\par\mbox{}}
\newdimen\mktsAdjustedParIndent
\mktsAdjustedParIndent=0em
\newskip\mktsAdjustedParSkip
\mktsAdjustedParSkip=0pt plus 1pt

{\mktsMakeActive\^^M
  \gdef\mktsObeyAllLines{%
    \parindent=\mktsAdjustedParIndent%
    \parskip=\mktsAdjustedParSkip%
    \mktsMakeActive\^^M%
    \let^^M=\mktsAdjustedPar%
    \leavevmode\hbox{}}}


% ==========================================================================================================
%
% 8888888888  .d88888b.  888b    888 88888888888  .d8888b.
% 888        d88P" "Y88b 8888b   888     888     d88P  Y88b
% 888        888     888 88888b  888     888     Y88b.
% 8888888    888     888 888Y88b 888     888      "Y888b.
% 888        888     888 888 Y88b888     888         "Y88b.
% 888        888     888 888  Y88888     888           "888
% 888        Y88b. .d88P 888   Y8888     888     Y88b  d88P
% 888         "Y88888P"  888    Y888     888      "Y8888P"
%
% ==========================================================================================================
%


% ==========================================================================================================
% 2) Display Styles
% ----------------------------------------------------------------------------------------------------------
\newcommand{\cjkInterchrSpacing}{\hskip -0.4pt plus 3pt minus 1pt}
\catcode`\=\active%
\def {\hskip -0.4pt plus 3pt minus 1pt}%
% definition from p3 of http://texdoc.net/texmf-dist/doc/xelatex/xecjk/xeCJK.pdf
% \newcommand{\cjkInterchrSpacing}{\hskip 0pt plus 0.08\baselineskip}
% \newcommand{\cjkInterchrSpacingA}{\hskip -0.4pt plus 3pt minus 1pt}
\newcommand{\adjustCjkIdeograph}[1]{\prRaise{-0.125}{#1}} % !!!
% \newcommand{\adjustJzrCjkIdeograph}[1]{\prRaise{-0.125}{#1}} % !!!
\newcommand{\adjustJzrCjkIdeograph}[1]{\prRaise{-0.125}{\makebox[1.1053\myFontsize]{#1}}} % !!!
\newcommand{\adjustKatakana}[1]{\cjkInterchrSpacing\prRaise{-0.125}{#1}}
\newcommand{\adjustHiragana}[1]{\cjkInterchrSpacing\prRaise{-0.125}{#1}}
\newcommand{\adjustHangeul}[1]{\cjkInterchrSpacing\prRaise{-0.125}{#1}}
% ..........................................................................................................
\newcommand{\latin}[1]{{\mktsFontfileEbgaramondtwelveregular#1}}
% \newcommand{\setPlainLatin}{\renewcommand{\latin}[1]{{\mktsFontfileEbgaramondtwelveregular#1}}}
% \newcommand{\setCodeLatin}{\renewcommand{\latin}[1]{{\mktsFontfileSunexta#1}}}
\newcommand{\py}[1]{{\mktsFontfileUbuntur#1}}
\newcommand{\ncr}[1]{{\mktsFontfileUbuntur#1}}
\newcommand{\gloss}[1]{{\mktsFontfileEbgaramondtwelveregular#1}}
% ..........................................................................................................
% \XeTeXlinebreaklocale "ja"% for Japanese
% \XeTeXlinebreakskip 0pt plus 0.1pt% sets the skip
% }
\newcommand{\mktsAdjustCjk}{%
  % \cjkInterchrSpacing%
  % Should fix CJK linebreaks as per http://tex.stackexchange.com/a/38276/28067
  % ### TAINT this setting should be made only available inside CJK text regions ###
  % \XeTeXlinebreaklocale "ja"% for Japanese
  % \XeTeXlinebreaklocale "zh"% for Chinese
  % \XeTeXlinebreakskip 0pt plus 0.1pt% sets the skip
  }
\newcommand{\cn}{\mktsAdjustCjk\mktsFontfileSunexta}
\newcommand{\cnxa}[1]{{\adjustCjkIdeograph{\mktsFontfileSunexta#1}}}
\newcommand{\cnxb}[1]{{\adjustCjkIdeograph{\mktsFontfileSunflowerucjkxb#1}}}
\newcommand{\cnxc}[1]{{\adjustCjkIdeograph{\mktsFontfileHanaminb#1}}}
\newcommand{\cnxd}[1]{{\adjustCjkIdeograph{\mktsFontfileBabelstonehan#1}}}
\newcommand{\cncone}[1]{{\adjustCjkIdeograph{\mktsFontfileSunexta#1}}}      	% CJK Compatibility 1
\newcommand{\cnctwo}[1]{{\adjustCjkIdeograph{\mktsFontfileHanamina#1}}}   				% CJK Compatibility 2
\newcommand{\cnrone}[1]{{\adjustCjkIdeograph{\mktsFontfileSunexta#1}}}      	% CJK Radicals 1
\newcommand{\cnrtwo}[1]{{\adjustCjkIdeograph{\mktsFontfileSunexta#1}}}      	% CJK Radicals 2
\newcommand{\cnsym}[1]{{\adjustCjkIdeograph{\mktsFontfileHanamina#1}}}
\newcommand{\cnstrk}[1]{{\adjustCjkIdeograph{\mktsFontfileSunexta#1}}}
% \newcommand{\cnjzr}[1]{{\cn{#1}}}       													% Jizura Font handled by CJK Block Declaration, above
\newcommand{\cnjzr}[1]{{\adjustJzrCjkIdeograph{\mktsFontfileJizurathreeb#1}}}
\newcommand{\ka}[1]{\adjustKatakana{\mktsFontfileNanummyeongjo#1}}
\newcommand{\hi}[1]{\adjustHiragana{\mktsFontfileNanummyeongjo#1}}
\newcommand{\hg}[1]{\adjustHangeul{\mktsFontfileNanummyeongjo#1}}
% ..........................................................................................................
\newcommand{\cnxBabel}[1]{{\adjustCjkIdeograph{\mktsFontfileBabelstonehan#1}}}
\newcommand{\cnxHanaA}[1]{{\adjustCjkIdeograph{\mktsFontfileHanamina#1}}}
\newcommand{\cnxHanaB}[1]{{\adjustCjkIdeograph{\mktsFontfileHanaminb#1}}}
\newcommand{\cnxSunXA}[1]{{\adjustCjkIdeograph{\mktsFontfileSunexta#1}}}
\newcommand{\cnxJzr}[1]{{\adjustJzrCjkIdeograph{\mktsFontfileJizurathreeb#1}}}
% \newcommand{\missing}[1]{{\missingFont#1}}
% ..........................................................................................................
\newcommand{\jzrStrokeclassZZWBF}{\prPushRaise{-0.1}{-0.1}{{\mktsFontfileJizurathreeb{}}}}
\newcommand{\jzrStrokeclassOne}{\prPushRaise{-0.1}{-0.1}{{\mktsFontfileJizurathreeb{}}}}
\newcommand{\jzrStrokeclassTwo}{\prPushRaise{-0.1}{-0.1}{{\mktsFontfileJizurathreeb{}}}}
\newcommand{\jzrStrokeclassThree}{\prPushRaise{-0.1}{-0.1}{{\mktsFontfileJizurathreeb{}}}}
\newcommand{\jzrStrokeclassFour}{\prPushRaise{-0.1}{-0.15}{{\mktsFontfileJizurathreeb{}}}}
\newcommand{\jzrStrokeclassFive}{\prPushRaise{-0.1}{-0.1}{{\mktsFontfileJizurathreeb{}}}}
\newcommand{\jzrStrokeclassLeftHook}{\prPushRaise{-0.1}{-0.1}{{\mktsFontfileJizurathreeb{}}}}
\newcommand{\jzrStrokeclassRightHook}{\prPushRaise{-0.1}{-0.1}{{\mktsFontfileJizurathreeb{}}}}
% ..........................................................................................................
\newcommand{\jzrStrokeclassTextZZWBF}{\prPushRaise{0}{-0.15}{{\mktsFontfileJizurathreeb{}}}}
\newcommand{\jzrStrokeclassTextOne}{\prPushRaise{0}{-0.15}{{\mktsFontfileJizurathreeb{}}}}
\newcommand{\jzrStrokeclassTextTwo}{\prPushRaise{0}{-0.15}{{\mktsFontfileJizurathreeb{}}}}
\newcommand{\jzrStrokeclassTextTwoHook}{\prPushRaise{0}{-0.15}{{\mktsFontfileJizurathreeb{}}}}
\newcommand{\jzrStrokeclassTextThree}{\prPushRaise{0}{-0.15}{{\mktsFontfileJizurathreeb{}}}}
\newcommand{\jzrStrokeclassTextFour}{\prPushRaise{0}{-0.15}{{\mktsFontfileJizurathreeb{}}}}
\newcommand{\jzrStrokeclassTextFourSlant}{\prPushRaise{0}{-0.15}{{\mktsFontfileJizurathreeb{}}}}
\newcommand{\jzrStrokeclassTextFive}{\prPushRaise{0}{-0.15}{{\mktsFontfileJizurathreeb{}}}}
\newcommand{\jzrStrokeclassTextLeftHook}{\prPushRaise{0}{-0.15}{{\mktsFontfileJizurathreeb{}}}}
\newcommand{\jzrStrokeclassTextRightHook}{\prPushRaise{0}{-0.15}{{\mktsFontfileJizurathreeb{}}}}
% ..........................................................................................................
\newcommand{\kai}[1]{{\mktsFontfileKai{}#1}}
\newcommand{\jzrkai}[1]{{\mktsFontfileJizurathreeb{}#1}}
% ..........................................................................................................
\newcommand{\pageNr}[1]{{\fontsize{2.5mm}{2.5mm}\mktsFontfilePtsans#1}}
\newcommand{\sfncr}[1]{{\fontsize{2mm}{2mm}\jzrFontInputMonoCompressedLight#1}}
\newcommand{\wbf}[1]{{\fontsize{2mm}{2mm}\jzrFontInputMonoCompressedMedium#1}}
\newcommand{\pageNrText}[1]{{\fontsize{3mm}{5mm}\mktsFontfilePtsans#1}}
\newcommand{\wbfText}[1]{{\fontsize{3mm}{5mm}\jzrFontInputMonoCompressedMedium#1}}
