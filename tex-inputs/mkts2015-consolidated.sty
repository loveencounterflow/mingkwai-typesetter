


% ==========================================================================================================
% Unicode and CJK Handling
% ----------------------------------------------------------------------------------------------------------
% ftp://ftp.tu-chemnitz.de/pub/tex/macros/latex/contrib/nag/nag.pdf
% \RequirePackage[l2tabu, orthodox]{nag}

\usepackage{fontspec}
% \usepackage{/home/flow/own/tex-packages/xeCJK-2.4.6-r306/xeCJK}
% \usepackage{xeCJK}

% % Should fix CJK linebreaks as per http://tex.stackexchange.com/a/38276/28067
% % ### TAINT this setting should be made only available inside CJK text regions ###
% \XeTeXlinebreaklocale "ja"% for Japanese
% \XeTeXlinebreakskip 0pt plus 0.1pt% sets the skip

\usepackage{lhelp}
\usepackage{leading}
\usepackage{multicol}
\usepackage{etextools}
\usepackage{array}
\usepackage{relsize}\renewcommand\RSlargest{100mm}\renewcommand\RSsmallest{0.1mm}
\usepackage{ragged2e}
\usepackage{needspace}
\usepackage[user,savepos]{zref}
% \usepackage{/Volumes/Storage/io/jizura-xelatex/tex-inputs/utils}
% \usepackage{/Users/flow/JIZURA/flow/dictionary/tex-inputs/accentbx/accentbx}
\usepackage{rotating}
\usepackage{pdflscape}
\usepackage{cxltx}
\usepackage{cxltx-style-accentbox}
\usepackage{cxltx-style-trm}
% \usepackage{longtable}
% \usepackage{pbox}
% \let\footruleskip\undefined\usepackage{fancyhdr}

% Package fixltx2e Warning: fixltx2e is not required with releases after 2015
% (fixltx2e)                All fixes are now in the LaTeX kernel.
% (fixltx2e)                See the latexrelease package for details.
% \usepackage{fixltx2e}

% \usepackage[usenames,dvipsnames,svgnames,table,x11names]{xcolor}
\usepackage[factor=1000]{microtype}
% ### TAINT need update for tracking:
% \usepackage[factor=1000,tracking=true]{microtype}
\usepackage{cxltx-style-base}
\usepackage{cxltx-style-oddeven}
\usepackage{cxltx-style-position-absolute}
\usepackage{cxltx-style-smashbox}

% ### TAINT to be replaced with something else ###
\usepackage{cxltx-style-cjkglue}

% \usepackage[null]{mkts-base} % plain
% \usepackage[null]{mkts-endnotes}
% % \usepackage[null]{mkts-page-geometry} % a4
% \usepackage[null]{mkts-headers-and-footers} % jizura
\usepackage[jizura]{mkts-headers-and-footers}%  jizura
% \usepackage[null]{mkts-fontsets}
% \usepackage[null]{mkts-styles}
% \usepackage[null]{mkts-para-font-size} % plain
% \usepackage[null]{mkts-headings-and-toc}

\usepackage[plain]{mkts-base}%                  plain
\usepackage[plain]{mkts-para-font-size}%        plain
\usepackage[default]{mkts-endnotes}%            default
\usepackage[default]{mkts-transform}%           default
% \usepackage[a4,cmgrid]{mkts-page-geometry}
% \usepackage[a4,baselines,ascenders,descenders]{mkts-page-geometry}
% \usepackage[a4,interbands,ascenders,baselines,descenders]{mkts-page-geometry}
% \usepackage[a4,ascenders,baselines,descenders]{mkts-page-geometry}
% \usepackage[a4,ascenders,descenders,baselines,columns]{mkts-page-geometry}
\usepackage[
  % papergrid,
  % textgrid,
  % linebands,
  % columns,
  % baselines,
  % ascenders,
  % descenders,
  % medians,
  % debug,
  % debugorigin,
  % gutter,
  outerborders,
  innerborders,
  % upperborders,
  % lowerborders,
  a4]{mkts-page-geometry}%
% \usepackage[a4,outer,debug,debugcopy,linebands,cmgrid,mmgrid]{mkts-page-geometry}%            a4
% \usepackage[a4]{mkts-page-geometry}%            a4
\usepackage[default]{mkts-fontsets}%            default
\usepackage[default]{mkts-styles}%              default
\usepackage[default]{mkts-headings-and-toc}%    default

% ----------------------------------------------------------------------------------------------------------
\newcommand{\mktsStyleBoxDrawing}{\mktsStyleFontCode}

% ----------------------------------------------------------------------------------------------------------
\newcommand{\mktsJzrVerticalbarInfix}{}%
\newcommand{\mktsJzrVerticalbarGlyph}{}%

  % ........................................................................................................
  \renewcommand{\mktsJzrVerticalbarInfix}{%
    % {\color{red}\hspace{0.2em}\makebox(0,0){\rule[0.5em]{0.15mm}{1.25em}}\hspace{0.2em}}%
    {\color{red}\hspace{0.2em}\rule[-0.4em]{0.15mm}{1.4em}\hspace{0.1em}}%
    % {\color{red}\rule[-0.4em]{0.15mm}{1.4em}}%
    }
  % ........................................................................................................
  \renewcommand{\mktsJzrVerticalbarGlyph}{%
    {\color{black}\hspace{0.2em}\rule[-0.4em]{0.15mm}{1.4em}\hspace{0.2em}}%
    }

\newcommand{\mktsJzrGlyphbraceLeft}{%
  {%
    \mktsFontfileSourcehansansheavy%
    \color{red}%
    \makebox[0mm]{「}%
    }%
  }

\newcommand{\mktsJzrGlyphbraceRight}{%
  {%
    \mktsFontfileSourcehansansheavy%
    \color{red}%
    \makebox[0mm]{」}%
    }%
  }

\newcommand{\mktsJzrGlyphdivider}{%
  {%
    \mktsFontfileHanamina%
    % \color{red}%
    % {\makebox(0,0){\rule[0em]{0.1mm}{1em}}}%
    \mktsScaleFontRelative{0.2}%
    {\mktstfRaise{+0.85}\makebox(0,0){▼}}%
    {\mktstfRaise{-0.35}\makebox(0,0){▲}}%
    }%
  }

\newenvironment{mktsEnvBlockquote}{%
  \par%
  % \mktsStyleItalic%
  \setlength{\leftskip}{\mktsLineheight}%
  \setlength{\rightskip}{\mktsLineheight}%
  \mktsScaleFontRelative{0.95}%
  % \setlength{\rightskip}{1em}%
  \ignorespaces}{%
  \par%
  }


% % ==========================================================================================================
% %
% %        d8888  888     888  Y88b   d88P
% %       d88888  888     888   Y88b d88P
% %      d88P888  888     888    Y88o88P
% %     d88P 888  888     888     Y888P
% %    d88P  888  888     888     d888b
% %   d88P   888  888     888    d88888b
% %  d8888888888  Y88b. .d88P   d88P Y88b
% % d88P     888   "Y88888P"   d88P   Y88b
% %
% % ==========================================================================================================
% % routines for writing to .aux file
% % this code copied from https://github.com/loveencounterflow/cxltx
% \makeatletter
% \catcode`\%=11
% \newcommand{\aux}[1]{\immediate\write\@auxout{#1}}
% \newcommand{\auxc}[1]{\immediate\write\@auxout{% #1}}
% \catcode`\%=14
% \makeatother


% ==========================================================================================================
%
% 8888888888  .d88888b.  888b    888 88888888888  .d8888b.
% 888        d88P" "Y88b 8888b   888     888     d88P  Y88b
% 888        888     888 88888b  888     888     Y88b.
% 8888888    888     888 888Y88b 888     888      "Y888b.
% 888        888     888 888 Y88b888     888         "Y88b.
% 888        888     888 888  Y88888     888           "888
% 888        Y88b. .d88P 888   Y8888     888     Y88b  d88P
% 888         "Y88888P"  888    Y888     888      "Y8888P"
%
% ==========================================================================================================
%


% ==========================================================================================================
% 2) Display Styles
% ----------------------------------------------------------------------------------------------------------
\newcommand{\latin}[1]{{\mktsFontfileEbgaramondtwelveregular#1}}
% \newcommand{\setPlainLatin}{\renewcommand{\latin}[1]{{\mktsFontfileEbgaramondtwelveregular#1}}}
% \newcommand{\setCodeLatin}{\renewcommand{\latin}[1]{{\mktsFontfileSunexta#1}}}
\newcommand{\py}{\mktsScaleFontRelative{0.8}\mktsFontfileUbuntur{}}
\newcommand{\ncr}[1]{{\mktsFontfileUbuntur#1}}
\newcommand{\gloss}{\mktsStyleItalic}
% ..........................................................................................................
% \XeTeXlinebreaklocale "ja"% for Japanese
% \XeTeXlinebreakskip 0pt plus 0.1pt% sets the skip
% }
\renewcommand{\cjkgGlue}{\hskip 0mm plus 0.7mm minus 0.0mm}
% \renewcommand{\cjkgGlue}{{\makebox[0mm]{\color{red}|}}\hskip 0mm plus 0.7mm minus 0.0mm}
\newcommand{\mktsCjkBase}{%
  \cjkgUseCjkGlue%
  \cjkgGlue%
  \mktsScaleFontRelative{1.1}%
  % ### TAINT using PDF special for better performance; won't scale to current font size
  \special{pdf:literal 1 0 0 1 0 -1.5 cm}%
  \AfterGroup{\special{pdf:literal 1 0 0 1 0 1.5 cm}%
    \cjkgGlue}%
  }
\newcommand{\cjk}{\mktsCjkBase}%

% \newcommand{\cn}{\mktsStartCjk\mktsFontfileSunexta}
\newcommand{\cn}{\cjkgGlue\mktsStyleFontCjkDefault\AfterGroup{\cjkgGlue}}
\newcommand{\mktsRsgFb}{\cjkgGlue\mktsFontfileSunexta\AfterGroup{\cjkgGlue}}
\newcommand{\cnxa}{\cjkgGlue\mktsFontfileSunexta\AfterGroup{\cjkgGlue}}
\newcommand{\cnxb}{\cjkgGlue\mktsFontfileSunflowerucjkxb\AfterGroup{\cjkgGlue}}
\newcommand{\cnxc}{\cjkgGlue\mktsFontfileHanaminb\AfterGroup{\cjkgGlue}}
% \newcommand{\cnxc}{\cjkgGlue\mktsFontfileSunextb\AfterGroup{\cjkgGlue}}
% \newcommand{\cnxc}{\cjkgGlue\mktsFontfileSunflowerucjkxb\AfterGroup{\cjkgGlue}}
\newcommand{\cnxd}{\cjkgGlue\mktsFontfileBabelstonehan\AfterGroup{\cjkgGlue}}
\newcommand{\cnUcjkcmp}{\cjkgGlue\mktsFontfileIpaexm\AfterGroup{\cjkgGlue}}       % CJK Compatibility 1
\newcommand{\cnUcjkcmpf}{\cjkgGlue\mktsFontfileHanamina\AfterGroup{\cjkgGlue}}    % CJK Compatibility 1
\newcommand{\cnUcjkcmpione}{\cjkgGlue\mktsFontfileHanamina\AfterGroup{\cjkgGlue}} % CJK Compatibility 1
\newcommand{\cnUcjkcmpitwo}{\cjkgGlue\mktsFontfileHanamina\AfterGroup{\cjkgGlue}} % CJK Compatibility 2
\newcommand{\cnrone}{\cjkgGlue\mktsFontfileSunexta\AfterGroup{\cjkgGlue}}       % CJK Radicals 1
\newcommand{\cnrtwo}{\cjkgGlue\mktsFontfileSunexta\AfterGroup{\cjkgGlue}}       % CJK Radicals 2
\newcommand{\cnsym}{\cjkgGlue\mktsFontfileHanamina\AfterGroup{\cjkgGlue}}
\newcommand{\cnstrk}{\cjkgGlue\mktsFontfileSunexta\AfterGroup{\cjkgGlue}}
\newcommand{\cnencsupp}{\cjkgGlue\mktsFontfileSarasaregular\AfterGroup{\cjkgGlue}}
% ..........................................................................................................
\newcommand{\cnxBabel}{\cjkgGlue\mktsFontfileBabelstonehan\AfterGroup{\cjkgGlue}}
\newcommand{\cnxHanaA}{\cjkgGlue\mktsFontfileHanamina\AfterGroup{\cjkgGlue}}
\newcommand{\cnxHanaB}{\cjkgGlue\mktsFontfileHanaminb\AfterGroup{\cjkgGlue}}
\newcommand{\cnxSunXA}{\cjkgGlue\mktsFontfileSunexta\AfterGroup{\cjkgGlue}}
\newcommand{\cnxUming}{\cjkgGlue\mktsFontfileUming\AfterGroup{\cjkgGlue}}
% ..........................................................................................................
\newcommand{\cnjzr}{%
  % \cn%
  \cjkgGlue%
  \mktsFontfileJizurathreeb%
  \AfterGroup{\cjkgGlue}%
  % \mktsScaleFontRelative{1.1}
  }%
\newcommand{\cnxJzr}{\cnjzr}
% \newcommand{\missing}[1]{{\missingFont#1}}
% ..........................................................................................................
% ### TAINT should use single kana definition and differentiate between hiragana, katakan only iff and where
% necessary; should *not* use font filename here but symbolic name ###
\newcommand{\ka}{%
  \cjkgGlue%
  % \mktsStyleFontKanaCurrent%
  \mktsStyleFontCjkDefault%
  \AfterGroup{\cjkgGlue}%
  }%

\newcommand{\mktsReadJa}{%
  \cjkgGlue%
  \renewcommand{\cjkgGlue}{\hskip -0.3ex plus 0.3ex minus 0.3ex}%
  % \mktsStyleFontKanaCurrent%
  % \mktsStyleFontCjkDefault%
  \mktsFontfileIpagp%
  \mktsScaleFontRelative{0.8}%
  \AfterGroup{\cjkgGlue}%
  }%

\newcommand{\mktsReadKo}{%
  \cjkgGlue%
  \renewcommand{\cjkgGlue}{\hskip -0.3ex plus 0.3ex minus 0.3ex}%
  % \mktsStyleFontKanaCurrent%
  % \mktsStyleFontCjkDefault%
  \mktsFontfileSourcehansansregular%
  \mktsScaleFontRelative{0.8}%
  \AfterGroup{\cjkgGlue}%
  }%

% \newcommand{\ka}{%
%   % \special{pdf:literal 1 0 0 1 0 0.5 cm}%
%   % \mktsStyleFontKanaCurrent%
%   % \mktsScaleFontRelative{1.2523}%
%   % \AfterGroup{\special{pdf:literal 1 0 0 1 0 -0.5 cm}}%
%   }
\newcommand{\hi}{\ka}

% \newcommand{\hi}{%
%   \special{pdf:literal 1 0 0 1 0 0.5 cm}%
%   \mktsFontfileFandolfangregular%
%   % \mktsScaleFontRelative{1.2523}%
%   \AfterGroup{\special{pdf:literal 1 0 0 1 0 -0.5 cm}}%
%   }

% \newcommand{\xxxFoo}{0.75}
% \pgfmathsetmacro{\xxxBar}{0.9 * \xxxFoo}
% \pgfmathsetmacro{\xxxBaz}{0.5 * 3}
  % \mktsScaleFontRelative{\xxxBar}%

\newcommand{\hg}{%
  % \special{pdf:literal 1 0 0 1 0 0.5 cm}%
  \mktsStyleFontHangeulDefault%
  \mktsScaleFontRelative{1}%
  % \mktsScaleFontRelative{1.15625}%
  % \AfterGroup{\special{pdf:literal 1 0 0 1 0 -0.5 cm}}%
  }
% ..........................................................................................................
\newcommand{\jzrStrokeclassZZWBF}{{\mktstfPushRaise{-0.1}{-0.1}\mktsFontfileJizurathreeb{}}}
\newcommand{\jzrStrokeclassVoid}{{\mktstfPushRaise{-0.1}{-0.1}\mktsFontfileSunexta{}　}}
\newcommand{\jzrStrokeclassZero}{{\mktstfPushRaise{-0.1}{-0.1}\mktsFontfileJizurathreeb{}}}
\newcommand{\jzrStrokeclassOne}{{\mktstfPushRaise{-0.1}{-0.1}\mktsFontfileJizurathreeb{}}}
\newcommand{\jzrStrokeclassTwo}{{\mktstfPushRaise{-0.1}{-0.1}\mktsFontfileJizurathreeb{}}}
\newcommand{\jzrStrokeclassThree}{{\mktstfPushRaise{-0.1}{-0.1}\mktsFontfileJizurathreeb{}}}
\newcommand{\jzrStrokeclassFour}{{\mktstfPushRaise{-0.1}{-0.15}\mktsFontfileJizurathreeb{}}}
\newcommand{\jzrStrokeclassFive}{{\mktstfPushRaise{-0.1}{-0.1}\mktsFontfileJizurathreeb{}}}
\newcommand{\jzrStrokeclassLeftHook}{{\mktstfPushRaise{-0.1}{-0.1}\mktsFontfileJizurathreeb{}}}
\newcommand{\jzrStrokeclassRightHook}{{\mktstfPushRaise{-0.1}{-0.1}\mktsFontfileJizurathreeb{}}}
% ..........................................................................................................
\newcommand{\jzrStrokeclassTextZZWBF}{{\mktstfPushRaise{0}{-0.15}\mktsFontfileJizurathreeb{}}}
\newcommand{\jzrStrokeclassTextOne}{{\mktstfPushRaise{0}{-0.15}\mktsFontfileJizurathreeb{}}}
\newcommand{\jzrStrokeclassTextTwo}{{\mktstfPushRaise{0}{-0.15}\mktsFontfileJizurathreeb{}}}
\newcommand{\jzrStrokeclassTextTwoHook}{{\mktstfPushRaise{0}{-0.15}\mktsFontfileJizurathreeb{}}}
\newcommand{\jzrStrokeclassTextThree}{{\mktstfPushRaise{0}{-0.15}\mktsFontfileJizurathreeb{}}}
\newcommand{\jzrStrokeclassTextFour}{{\mktstfPushRaise{0}{-0.15}\mktsFontfileJizurathreeb{}}}
\newcommand{\jzrStrokeclassTextFourSlant}{{\mktstfPushRaise{0}{-0.15}\mktsFontfileJizurathreeb{}}}
\newcommand{\jzrStrokeclassTextFive}{{\mktstfPushRaise{0}{-0.15}\mktsFontfileJizurathreeb{}}}
\newcommand{\jzrStrokeclassTextLeftHook}{{\mktstfPushRaise{0}{-0.15}\mktsFontfileJizurathreeb{}}}
\newcommand{\jzrStrokeclassTextRightHook}{{\mktstfPushRaise{0}{-0.15}\mktsFontfileJizurathreeb{}}}
% ..........................................................................................................
\newcommand{\kai}{\renewcommand{\mktsStyleFontCjkDefault}{\mktsFontfileBiaukai}}
\newcommand{\jzrkai}[1]{{\mktsFontfileJizurathreeb{}#1}}
% ..........................................................................................................
% \newcommand{\pageNr}[1]{{\fontsize{2.5mm}{2.5mm}\mktsFontfilePtsans#1}}
% \newcommand{\sfncr}[1]{{\fontsize{2mm}{2mm}\jzrFontInputMonoCompressedLight#1}}
% \newcommand{\wbf}[1]{{\fontsize{2mm}{2mm}\mktsFontfileIosevkaslabbold#1}}
% \newcommand{\pageNrText}[1]{{\fontsize{3mm}{5mm}\mktsFontfilePtsans#1}}
% \newcommand{\wbfText}[1]{{\fontsize{3mm}{5mm}\jzrFontInputMonoCompressedMedium#1}}


% ### TAINT should only be loaded when needed ###
% \usepackage{struktex}
\usepackage{tikz}
\usetikzlibrary{ shapes.geometric, arrows, calc, backgrounds, decorations, patterns }
\usepackage{mkts-tikz-patterns}%
% \tikzstyle{startstop} = [rectangle, rounded corners, minimum width=3cm, minimum height=1cm,text centered, draw=black, fill=red!30]
% \tikzstyle{io} = [trapezium, trapezium left angle=70, trapezium right angle=110, minimum width=3cm, minimum height=1cm, text centered, draw=black, fill=blue!30]
% \tikzstyle{process} = [rectangle, minimum width=3cm, minimum height=1cm, text centered, draw=black, fill=orange!30]
% \tikzstyle{decision} = [diamond, minimum width=3cm, minimum height=1cm, text centered, draw=black, fill=green!30]
% \tikzstyle{arrow} = [thick,->,>=stealth]


% ----------------------------------------------------------------------------------
% ##################################################################################
% ==================================================================================

% DECORATIONS (should got into module of their own)

% ==================================================================================
% ##################################################################################
% ----------------------------------------------------------------------------------


\usepackage{adjustbox}
\definecolor{jzrBlue}{RGB}{0,94,129}
\definecolor{jzrDarkBlue}{RGB}{0,60,110}

\newdimen\myFontsize
\setlength{\myFontsize}{5mm}
\newdimen\kwicwrapStrutWidth
\newdimen\kwicwrapStrutDoubleTopLength
\newdimen\kwicwrapStrutDoubleTopHeight
\newdimen\kwicwrapStrutDoubleTopDepth
\setlength{\kwicwrapStrutDoubleTopLength}{2.85\myFontsize}
% \setlength{\kwicwrapStrutDoubleTopLength}{2.4\myFontsize-0.155mm}
\setlength{\kwicwrapStrutDoubleTopHeight}{0.5\kwicwrapStrutDoubleTopLength}
\setlength{\kwicwrapStrutDoubleTopDepth}{\kwicwrapStrutDoubleTopLength-\kwicwrapStrutDoubleTopHeight}
% ..........................................................................................................
\kwicwrapStrutWidth=0mm
\newcommand{\kwicwrapStrutDoubleTop}{{\color{blue}\vrule height\kwicwrapStrutDoubleTopHeight width\kwicwrapStrutWidth depth\kwicwrapStrutDoubleTopDepth}}
\newdimen\kwicwrapStrutCircleLength
\newdimen\kwicwrapStrutCircleHeight
\newdimen\kwicwrapStrutCircleDepth
\newdimen\kwicwrapStrutCircleFontsize
\setlength{\kwicwrapStrutCircleLength}{1.25\myFontsize}
\setlength{\kwicwrapStrutCircleHeight}{0.7\kwicwrapStrutCircleLength}
\setlength{\kwicwrapStrutCircleDepth}{\kwicwrapStrutCircleLength-\kwicwrapStrutCircleHeight}
\setlength{\kwicwrapStrutCircleFontsize}{1.0\kwicwrapStrutCircleLength}
%\newcommand{\kwicwrapStrutCircle}{{\color{blue}\vrule height\kwicwrapStrutCircleHeight width\kwicwrapStrutWidth depth\kwicwrapStrutCircleDepth}}
\newcommand{\kwicwrapStrutCircle}{\vrule %
  height\kwicwrapStrutCircleHeight %
  width\kwicwrapStrutWidth %
  depth\kwicwrapStrutCircleDepth}
\newcommand*\kwicwrapCircledInner[1]{%
  \makebox[12.5mm]{\kwicwrapStrutDoubleTop\smash{%
  \begin{adjustbox}{trim=-2.25mm 0mm 0mm 0}%
  % \begin{adjustbox}{trim=8.5mm 0mm 0mm 0}%
    \tikz[baseline=(char.base),line width=0.5mm]{%
      \node[shape=circle,draw,inner sep=0.55mm,jzrDarkBlue,fill=jzrBlue] (char) {%
      \makebox[\kwicwrapStrutCircleLength]{\kwicwrapStrutCircle\smash{{%
        \color{white}%
        \mktstfPushRaise{0.03}{-0.3}#1}%
        }}}%
  ;}%
  \end{adjustbox}%
  }}}

% ### TAINT parametrize font scaling factor
\newcommand*\kwicwrapCircled[1]{%
  \kwicwrapCircledInner{\mktsScaleFontRelative{2}#1}}%
\newcommand{\kwicwrapCircledOne}{\kwicwrapCircled{\cjk{}{\cnjzr{}}}}
\newcommand{\kwicwrapCircledTwo}{\kwicwrapCircled{\cjk{}{\cnjzr{}}}}
\newcommand{\kwicwrapCircledThree}{\kwicwrapCircled{\cjk{}{\cnjzr{}}}}
\newcommand{\kwicwrapCircledFour}{\kwicwrapCircled{\cjk{}{\cnjzr{}}}}
\newcommand{\kwicwrapCircledFive}{\kwicwrapCircled{\cjk{}{\cnjzr{}}}}


% \newcommand{\mktsXxxxstrut}[1]{{%
%   \color{blue}%
%   \rule[0mm]{1mm}{#1\mktsLineheight}%
%   }}

% ----------------------------------------------------------------------------------------------------------
\usepackage[usestackEOL]{stackengine}

% ----------------------------------------------------------------------------------------------------------
\newcommand{\mktsFncrStacked}[3]{{%
  \smash{%
    \thinspace%
    \mbox{%
      {\mktstfRaise{-0.25}%
        \mktsStyleFncr%
        \mktsScaleFontRelative{0.7}%
        \setstackgap{L}{\mktsCurrentFontsize}%
        \Longstack{#1\\#2}}}%
  \thinspace\mktsStyleFncr{}#3}}}%

% ----------------------------------------------------------------------------------------------------------
\newcommand{\mktsFncr}[3]{{%
  \mktsScaleFontRelative{0.8}%
  {\mktsFontfileIosevkatermslabbold#1+#3}%
  \thinspace%
  {\mktstfRaise{-0.2}\mktsScaleFontRelative{0.5}\mktsFontfileIosevkatermslabmediumitalic#2}%
  \thinspace%
  }}%

% ----------------------------------------------------------------------------------------------------------
\usepackage{refcount}
% usage:
%   \label{foobarone}
%   ...
%   \mktsPagerefCompare{foobarone}{<}{=}{>}
% chooses one of the arguments based on comparinf current page with page where label occurs
\newcommand{\mktsPagerefCompare}[4]{%
  \ifnumequal{\getpagerefnumber{#1}}{\thepage}{#3}{%
    \ifnumless{\getpagerefnumber{#1}}{\thepage}{#2}{#4}}}%

% ----------------------------------------------------------------------------------------------------------
% like `\mktsPagerefCompare`, chooses style, spacing, appropriate arrow; prints prefix and pagenr
\newcommand{\mktsPagerefArrow}[1]{{%
  \mktsStylePagenr{\mktsFontfileIosevkatermslabbold\mktsPagerefCompare{#1}{↑}{↕}{↓}}\thinspace{}p\thinspace\getpagerefnumber{#1}}}%

% ----------------------------------------------------------------------------------------------------------
% ### TAINT using absolute, direct dimensions instead of relative, symbolic ones
\newcommand{\jzrStrokeclassCircled}[1]{%
  \makebox[4mm]{%
    \makebox[0mm]{{%
      \mktsScaleFontRelative{0.8}%
      {\mktstfPushRaise{-0.1}{+0.05}\mktsFontfileJizurathreeb{}#1}}}%
    \makebox[0mm]{{%
      \mktsScaleFontRelative{1.25}%
      {\mktstfPushRaise{-0.1}{-0.1}\mktsFontfileJizurathreeb{}}}}%
      }}%

% ----------------------------------------------------------------------------------------------------------
% ### TAINT using absolute, direct dimensions instead of relative, symbolic ones
\newcommand{\jzrStrokeclassCircledSingle}{%
  \makebox[4mm]{%
    \makebox[0mm]{{%
      \mktsScaleFontRelative{1.25}%
      {\mktstfPushRaise{-0.1}{-0.1}\mktsFontfileJizurathreeb{}}}}%
      }}%

% ----------------------------------------------------------------------------------------------------------
% ### TAINT using absolute, direct dimensions instead of relative, symbolic ones
\newcommand{\jzrStrokeclassCircledZero}[1]{%
  \makebox[4mm]{%
    \makebox[0mm]{{%
      \mktsScaleFontRelative{1.25}%
      {\mktstfPushRaise{-0.1}{-0.1}\mktsFontfileJizurathreeb{}}}}%
      }}%

% ----------------------------------------------------------------------------------------------------------
% ### TAINT using absolute, direct dimensions instead of relative, symbolic ones
\newcommand{\mktsCircledLetter}[1]{%
  \makebox[4mm]{%
    \makebox[0mm]{{%
      \mktsScaleFontRelative{0.8}%
      {\mktstfPushRaise{-0.1}{-0.05}\mktsStyleFontCode{}#1}}}%
    \makebox[0mm]{{%
      \mktsScaleFontRelative{1.25}%
      {\mktstfPushRaise{-0.1}{-0.15}\mktsFontfileJizurathreeb{}}}}%
      }}%

% ----------------------------------------------------------------------------------------------------------
% ### TAINT using absolute, direct dimensions instead of relative, symbolic ones
\newcommand{\mktsBoxedLetter}[1]{%
  \makebox[4mm]{%
    \makebox[0mm]{{%
      \mktsScaleFontRelative{0.8}%
      {\mktstfPushRaise{-0.1}{-0.05}\mktsStyleFontCode{}#1}}}%
    \makebox[0mm]{{%
      \mktsScaleFontRelative{1.25}%
      {\mktstfPushRaise{-0.1}{-0.18}\mktsFontfileSourcehansansbold{}□}}}%
      }}%

% ### TAINT using absolute, direct dimensions instead of relative, symbolic ones
\newcommand{\jzrStrokeclassCircledVoid}{\makebox[4mm]}%
\newcommand{\jzrStrokeclassCircledTest}{\jzrStrokeclassCircled{}}%
\newcommand{\jzrStrokeclassCircledOne}{\jzrStrokeclassCircled{}}%
\newcommand{\jzrStrokeclassCircledTwo}{\jzrStrokeclassCircled{}}%
\newcommand{\jzrStrokeclassCircledThree}{\jzrStrokeclassCircled{}}%
\newcommand{\jzrStrokeclassCircledFour}{\jzrStrokeclassCircled{}}%
\newcommand{\jzrStrokeclassCircledFive}{\jzrStrokeclassCircled{}}%

% ----------------------------------------------------------------------------------------------------------
\newcommand{\mktsBoxedGlyph}[1]{%
  \thinspace\setlength{\fboxsep}{0.1mm}%
  {\mktstfRaise{-0.3}\fbox{{\mktstfRaise{0.35}#1}}}}%

% ----------------------------------------------------------------------------------------------------------
\newcommand{\mktsIndent}{{\mktsStyleFontCjkDefault{}^^^^3000}}%

% ----------------------------------------------------------------------------------------------------------
\newcommand{\cspc}{\hspace{0.2\mktsFontsize}}%
\newcommand{\ccspc}{\hspace{1.1\mktsFontsize}}%

% ----------------------------------------------------------------------------------------------------------
\newcommand{\herex}[1]{{%
  \auxc{herex}%
  \oeIfEvenPage{%
    \setlength{\mktsGeoTmpOne}{\mktsGeoLeftmostTextXEven}}{%
    \setlength{\mktsGeoTmpOne}{\mktsGeoLeftmostTextXOdd}}%
  \color{red}%
  \makebox[0mm][l]{%
    \mktsFontfileSunexta{}%
    {\mktstfPushRaise{-0.11}{0.3}⥒}%
    }\zsavepos{#1}%
  \makebox[0mm][l]{%
    {\mktstfPushRaise{1.1}{0.75}\mktsStyleFontCode\mktsScaleFontRelative{0.5}\showx{#1}\thinspace{}mm}}%
    }}%

% ----------------------------------------------------------------------------------------------------------
\newcommand{\showx}[1]{%
  % ### TAINT use variable instead of symlink to find MKTS path
  % \exec{echo '"as_here_x_ref","\zposx{#1}","sp","\ctConvertTo{mm}{\the\mktsGeoTmpOne}","mm"' | nc 127.0.0.1 8910}}
  \execdebug{echo '"as_here_x_ref","\zposx{#1}","sp","\ctConvertTo{mm}{\the\mktsGeoTmpOne}","mm"' | nc 127.0.0.1 8910}}
  % \exec{node mingkwai-typesetter/lib/cxltx-demo.js as_here_x_ref \zposx{#1} sp \ctConvertTo{mm}{\the\mktsGeoTmpOne} mm}}

% ----------------------------------------------------------------------------------------------------------
% xFormula status code
% parameters: 1) xfsc, 2) symbol (colon or somesuch)
\newcommand{\mktsXfsc}[2]{{%
  \makebox[0.5\mktsFontsize]{%
    \mktsStyleFontCode%
    {\mktstfPushRaise{0}{-0.25}\mktsScaleFontRelative{0.8}#2}%
    \makebox[0mm]{\mktstfPushRaise{-0.4}{0.4}\mktsScaleFontRelative{0.5}#1}}}}

% ----------------------------------------------------------------------------------------------------------
% Underlines with gaps for descenders
% Observe that line breaks are inhibited by this style
% thx to https://alexwlchan.net/2017/10/latex-underlines/
% https://github.com/alexwlchan/alexwlchan.net/blob/56aa9010ba2a5ce232132359e528751df75f2466/scripts/latex-underlines/example_final.tex
\usepackage{contour}
\usepackage{ulem}
\renewcommand{\ULdepth}{1.8pt}%       ### TAINT use fontsize-relative length
\contourlength{0.8pt}%                ### TAINT use fontsize-relative length
\newcommand{\mktsUnderline}[1]{\uline{\phantom{#1}}\llap{\contour{white}{#1}}}%

% thx to https://tex.stackexchange.com/a/22928/128255
\newcommand{\mktsColorframebox}[2]{%
  \colorlet{currentcolor}{.}%
  {\color{#1}%
  \fbox{\color{currentcolor}#2}}}%

% ----------------------------------------------------------------------------------------------------------
\newcommand{\mktsStyleCjkRoundSymbol}[1]{%
  \phantom{{\cn{}國}}\makebox[0mm]{\mktstfPushRaise{-1.25}{-0.15}\mktsFontfileThtshynpone\mktsScaleFontRelative{1.7}#1}}%

% ----------------------------------------------------------------------------------------------------------
% ### TAINT untested ###
% consider to implement using `\begin{flushleft}` etc from package `ragged2e`
% as per https://www.overleaf.com/learn/latex/Text_alignment
% also see https://en.wikibooks.org/wiki/LaTeX/Paragraph_Formatting
\newcommand{\mktsLeft}{%
  \raggedright}%
\newcommand{\mktsRight}{%
  \raggedleft}%
\newcommand{\mktsCenter}{%
  \centering}%
\newcommand{\mktsJustify}{%
  \justify}%


% ----------------------------------------------------------------------------------------------------------
% Boxed type
% 1—color of background
% 2—color of border
% 3—color of foreground
% 4—text
\newcommand{\mktsPillbox}[4]{%
  \tikz[baseline=(char.base),line width=0.1ex]{%
    \node[shape=rectangle,inner xsep=0.5ex,inner ysep=0.5ex,rounded corners = 0.5ex,draw,#2,fill=#1]
      (char) {%
      \color{#3}%
      \mktsScaleFontRelative{0.8}%
      \mktsFontfileRobotocondensedbold{}%
      \makebox[0ex]{\phantom{Wfg}}\thinspace{}{\mktstfRaise{-0.025}#4}\thinspace}}}%

% ----------------------------------------------------------------------------------------------------------
% White-on-black text in a box with round corners
\newcommand{\mktsBPillbox}[1]{\mktsPillbox{black}{black}{white}{#1}}
\newcommand{\mktsWPillbox}[1]{\mktsPillbox{white}{black}{black}{#1}}

% ----------------------------------------------------------------------------------------------------------
% Rotated text
\newcommand{\mktsTurn}[2]{%
  \turnbox{#1}{#2}}


% ----------------------------------------------------------------------------------------------------------
% Scaled text
\newcommand{\mktsZoom}[2]{%
  % currently, does nothing; will implement \scalebox / \resizebox from graphics package
  }%


% Do not use setspace, as per https://tex.stackexchange.com/q/410250/128255
% \usepackage{setspace}%
% ..........................................................................................................
\newcommand{\mktsScaleText}[1]{%
  \setlength{\mktsCurrentFontsize}{#1\mktsFontsize}%
  \setlength{\mktsCurrentLineheight}{#1\mktsLineheight}%
  \fontsize{\mktsCurrentFontsize}{\mktsCurrentLineheight}\selectfont}%

% ..........................................................................................................
\newcommand{\mktsScaleTextRelative}[1]{%
  \setlength{\mktsCurrentFontsize}{#1\mktsCurrentFontsize}%
  \setlength{\mktsCurrentLineheight}{#1\mktsCurrentLineheight}%
  \fontsize{\mktsCurrentFontsize}{\mktsCurrentLineheight}\selectfont}%

% ..........................................................................................................
\newcommand{\mktsStretchLinesAbsolute}[1]{%
  \setlength{\mktsCurrentLineheight}{#1\mktsLineheight}%
  \fontsize{\mktsCurrentFontsize}{\mktsCurrentLineheight}\selectfont}%

% ..........................................................................................................
\newcommand{\mktsStretchLinesRelative}[1]{%
  \setlength{\mktsCurrentLineheight}{#1\mktsCurrentLineheight}%
  \fontsize{\mktsCurrentFontsize}{\mktsCurrentLineheight}\selectfont}%

% ----------------------------------------------------------------------------------------------------------
% ad hoc tiny typeface
\newcommand{\mktsTiny}{\mktsScaleTextRelative{0.5}}

% ----------------------------------------------------------------------------------------------------------
% Convert lengths to pure numbers
% thx to https://tex.stackexchange.com/a/15002/128255
\makeatletter%
\newcommand*{\mktsLengthAsNumber}[1]{\strip@pt#1}%
\makeatother%

% ----------------------------------------------------------------------------------------------------------
\newcommand*{\mktsCurrentFontsizeScale}{%
  \FPdiv\R{\mktsLengthAsNumber{\mktsCurrentFontsize}}{\mktsLengthAsNumber{\mktsFontsize}}%
  \R}%

% ----------------------------------------------------------------------------------------------------------
% thx to https://tex.stackexchange.com/a/94702
% ### TAINT tests indicate that `mktsSamepage` does not work correctly other than in the last column
% of a page; otherwise, it will cause all columns to the right to remain blank.
\newenvironment{mktsSamepage}
  {\par\nobreak\vfil\penalty0\vfilneg
   \vtop\bgroup}
  {\par\xdef\tpd{\the\prevdepth}\egroup
   \prevdepth=\tpd}

% ----------------------------------------------------------------------------------------------------------
% Used to separate suffix strokeclass groups in 3-column layout
\newcommand{\mktsThreeColOverline}{%
  \begin{tikzpicture}[ overlay, yshift = 5mm, yscale = -1, line cap = rect ]%
  \tikzset{x=5.26mm,y=5.26mm};\draw[thin] (0,0.25) -- (11,0.25);\end{tikzpicture}}






