{"version":3,"sources":["macro-escaper.coffee"],"names":[],"mappings":"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","file":"macro-escaper.js","sourceRoot":"/source/","sourcesContent":["\n\n\n############################################################################################################\n# njs_path                  = require 'path'\nnjs_fs                    = require 'fs'\n#...........................................................................................................\nCND                       = require 'cnd'\nrpr                       = CND.rpr\nbadge                     = 'MKTS/MACRO-ESCAPER'\nlog                       = CND.get_logger 'plain',     badge\ninfo                      = CND.get_logger 'info',      badge\nwhisper                   = CND.get_logger 'whisper',   badge\nalert                     = CND.get_logger 'alert',     badge\ndebug                     = CND.get_logger 'debug',     badge\nwarn                      = CND.get_logger 'warn',      badge\nhelp                      = CND.get_logger 'help',      badge\nurge                      = CND.get_logger 'urge',      badge\necho                      = CND.echo.bind CND\n#-----------------------------------------------------------------------------------------------------------\nD                         = require 'pipedreams'\n$                         = D.remit.bind D\n# $async                    = D.remit_async.bind D\n#...........................................................................................................\n# Markdown_parser           = require 'markdown-it'\n# # Html_parser               = ( require 'htmlparser2' ).Parser\n# new_md_inline_plugin      = require 'markdown-it-regexp'\n#...........................................................................................................\n# HELPERS                   = require './HELPERS'\n#...........................................................................................................\n# misfit                    = Symbol 'misfit'\nMKTS                      = require './main'\n@cloak                    = ( require './cloak' ).new()\n# hide                      = MKTS.hide.bind        MKTS\n# copy                      = MKTS.MD_READER.copy.bind        MKTS\n# stamp                     = MKTS.stamp.bind       MKTS\n# select                    = MKTS.MD_READER.select.bind      MKTS\n# is_hidden                 = MKTS.is_hidden.bind   MKTS\n# is_stamped                = MKTS.is_stamped.bind  MKTS\n\n\n#===========================================================================================================\n# HELPERS\n#-----------------------------------------------------------------------------------------------------------\n@initialize_state = ( state ) =>\n  state[ 'MACRO_ESCAPER' ] =\n    registry:   []\n  return state\n\n#-----------------------------------------------------------------------------------------------------------\n@_match_first = ( patterns, text ) =>\n  for pattern in patterns\n    return R if ( R = text.match pattern )?\n  return null\n\n#-----------------------------------------------------------------------------------------------------------\n@_register_content = ( S, kind, markup, raw, parsed = null ) =>\n  registry  = S[ 'MACRO_ESCAPER' ][ 'registry' ]\n  idx     = registry.length\n  key     = \"#{kind}#{idx}\"\n  registry.push { key, markup, raw, parsed, }\n  return key\n\n#-----------------------------------------------------------------------------------------------------------\n@_retrieve_entry = ( S, id ) =>\n  throw new Error \"unknown ID #{rpr id}\" unless ( R = S[ 'MACRO_ESCAPER' ][ 'registry' ][ id ] )?\n  return R\n\n#===========================================================================================================\n# PATTERNS\n#-----------------------------------------------------------------------------------------------------------\n@PATTERNS = {}\n\n#-----------------------------------------------------------------------------------------------------------\n@html_comment_patterns = [\n  ///                           # HTML comments...\n    <!--                        # start with less-than, exclamation mark, double hyphen;\n    ( [ \\s\\S ]*? )              # then: anything, not-greedy, until we hit upon\n    -->                         # a double-slash, then greater-than.\n    ///g                        # (NB: end-of-comment cannot be escaped, because HTML).\n  ]\n\n#-----------------------------------------------------------------------------------------------------------\n@action_patterns = [\n  ///                           # A silent or vocal action macro...\n                                #\n                                # Start Tag\n                                # =========\n  <<\\(                          # starts with two left pointy brackets, then: left round bracket,\n    ( [ . : ] )                 # then: a dot or a colon;\n    (\n      (?:                       # then:\n        [^ > ]             |    #   or: anything but a RPB\n        > (?! > )               #   or: a RPB not followed by yet another RPB\n      )*                        # repeated any number of times\n    )\n    >>                          # then: two RPBs...\n                                #\n                                # Content\n                                # =========\n                                # Empty content.\n                                #\n                                # Stop Tag\n                                # =========\n  () <<                         # (then: an empty group; see below), then: two left pointy brackets,\n    ( (?: \\1 \\2 )? )            # then: optionally, whatever appeared in the start tag,\n    \\)>>                        # then: right round bracket, then: two RPBs.\n  ///g\n  ,                             #...........................................................................\n  ///                           # Alternatively (non-empty content):\n                                #\n                                # Start Tag\n                                # =========\n  <<\\(                          # starts with two left pointy brackets, then: left round bracket,\n    ( [ . : ] )                 # then: a dot or a colon;\n    (\n      (?:                       # then:\n        [^ > ]             |    #   or: anything but a RPB\n        > (?! > )               #   or: a RPB not followed by yet another RPB\n      )*                        # repeated any number of times\n    )\n    >>                          # then: two RPBs...\n                                #\n                                # Content\n                                # =========\n    (\n      (?:                       # ...followed by content, which is:\n        [^ < ]             |    #   or: anything but a LPB\n        < (?! < )               #   or: a LPB not followed by yet another LPB\n        )*                      # repeated any number of times\n      )\n                                #\n                                # Stop Tag\n                                # =========\n  <<                            # then: two left pointy brackets,\n    ( (?: \\1 \\2 )? )            # then: optionally, whatever appeared in the start tag,\n    \\)>>                        # then: right round bracket, then: two RPBs.\n  ///g\n  ]\n\n#-----------------------------------------------------------------------------------------------------------\n@region_patterns = [\n  ///                           # A region macro tag...\n                                #\n                                # Start Tag\n                                # =========\n  <<                            # starts with two left pointy brackets\n  ( \\( )                        # then: left round bracket,\n    (                           #\n      (?:                       # then:\n        [^ > ]             |    #   or: anything but a RPB\n        > (?! > )               #   or: a RPB not followed by yet another RPB\n      )*                        # repeated any number of times\n    )\n    ()                          # then: empty group for no markup here\n    >>                          # then: two RPBs.\n  ///g\n  ,\n  ///                           # Stop Tag\n                                # ========\n                                #\n  <<                            # starts with two left pointy brackets\n    ()                          # then: empty group for no markup here\n    ( |                         #\n      [^ . : ]\n      (?:                       # then:\n        [^ > ]             |    #   or: anything but a RPB\n        > (?! > )               #   or: a RPB not followed by yet another RPB\n      )*                        # repeated any number of times\n    )\n    ( \\) )                      # a right round bracket;\n    >>                          # then: two RPBs.\n  ///g\n  ]\n\n# debug '234652', @action_patterns\n# debug \"abc<<(:js>>4 + 3<<:js)>>def\".match @action_patterns[ 0 ]\n# process.exit()\n\n#-----------------------------------------------------------------------------------------------------------\n@bracketed_raw_patterns = [\n  ///                           # A bracketed raw macro\n  <<(<)                         # starts with three left pointy brackets,\n    (\n      (?:                       # then:\n        [^ > ]             |    #   or: anything but a RPB\n        >{1,2} (?! > )          #   or: one or two RPBs not followed by yet another RPB\n      )*                        # repeated any number of times\n    )\n    >>>                         # then: three RPBs.\n  ///g\n  ]\n\n#-----------------------------------------------------------------------------------------------------------\n@comma_patterns = [\n  ///                           # Comma macro to separate arguments within macro regions\n  <<,>>\n  ///g\n  ]\n\n# #-----------------------------------------------------------------------------------------------------------\n# @raw_heredoc_pattern  = ///\n#   ( ^ | [^\\\\] ) <<! raw: ( [^\\s>]* )>> ( .*? ) \\2\n#   ///g\n\n#-----------------------------------------------------------------------------------------------------------\n@command_and_value_patterns = [\n  ///                           # A command macro\n  <<                            # starts with two left pointy brackets,\n    ( [ ! $ ] )                 # then: an exclamation mark or a dollar sign,\n    (\n      (?:                       # then:\n        [^ > ]             |    #   or: anything but a RPB\n        > (?! > )               #   or: a RPB not followed by yet another RPB\n      )*                        # repeated any number of times\n    )\n    >>                          # then: two RPBs.\n  ///g\n  ]\n\n#-----------------------------------------------------------------------------------------------------------\n@insert_command_patterns = [\n  ///                           # An insert command macro\n  <<                            # starts with two left pointy brackets,\n    ( [ ! $ ] )                 # then: an exclamation mark or a dollar sign,\n    insert (?= [\\s>] )          # then: an 'insert' literal (followed by WS or RPB)\n    (\n      (?:                       # then:\n        [^ > ]             |    #   or: anything but a RPB\n        > (?! > )               #   or: a RPB not followed by yet another RPB\n      )*                        # repeated any number of times\n    )\n    >>                          # then: two RPBs.\n  ///g\n  ]\n\n#-----------------------------------------------------------------------------------------------------------\n### NB The end command macro looks like any other command except we can detect it with a much simpler\nRegEx; we want to do that so we can, as a first processing step, remove it and any material that appears\nafter it, thereby inhibiting any processing of those portions. ###\n@end_command_patterns = [\n  ///                           # Then end command macro\n  ( ^ |                         # starts either at the first chr\n    ^ [ \\s\\S ]+? [^ \\\\ ] )      # or a minimal number of chrs whose last one is not a backslash\n  <<!end>>                      # then: the `<<!end>>` literal.\n  ///                           # NB that this pattern is not global.\n  ]\n\n#-----------------------------------------------------------------------------------------------------------\n@illegal_patterns = [\n  ///                           # After applying all other macro patterns, treat as error\n  ( << | >> )                   # any occurrances of two left or two right pointy brackets.\n  ///g\n  ]\n\n#===========================================================================================================\n# ESCAPING\n#-----------------------------------------------------------------------------------------------------------\n@escape = ( S, text ) =>\n  # debug '©II6XI', rpr text\n  [ R, discard_count, ] = @escape.truncate_text_at_end_command_macro S, text\n  whisper \"detected <<!end>> macro; discarding approx. #{discard_count} characters\" if discard_count > 0\n  R = @escape.escape_chrs               S, R\n  R = @escape.html_comments             S, R\n  # R = @escape.sensitive_ws              S, R\n  R = @escape.bracketed_raw_macros      S, R\n  R = @escape.insert_macros             S, R\n  R = @escape.action_macros             S, R\n  R = @escape.region_macros             S, R\n  R = @escape.comma_macros              S, R\n  R = @escape.command_and_value_macros  S, R\n  #.........................................................................................................\n  return R\n\n#-----------------------------------------------------------------------------------------------------------\n@escape.truncate_text_at_end_command_macro = ( S, text ) =>\n  return [ text, 0, ] unless ( match = @_match_first @end_command_patterns, text )?\n  R = match[ 1 ]\n  # urge '©ΣΩΗΔΨ', rpr R\n  return [ R, text.length - R.length, ]\n\n#-----------------------------------------------------------------------------------------------------------\n@escape.escape_chrs                 = ( S, text ) => @cloak.backslashed.hide  @cloak.hide               text\n@escape.unescape_escape_chrs        = ( S, text ) => @cloak.reveal            @cloak.backslashed.reveal text\n@escape.remove_escaping_backslashes = ( S, text ) => @cloak.backslashed.remove text\n\n#-----------------------------------------------------------------------------------------------------------\n@escape.sensitive_ws = ( S, text ) =>\n  ### Fixes an annoying parsing problem with Markdown-it where the leading whitespace in\n  ```\n  <<(keep-lines>>\n  　　　　　　　|𠦝韦　　　　　　韩\n  ```\n  is kept but deleted when the first line is blank, as in\n  ```\n  <<(keep-lines>>\n\n  　　　　　　　|𠦝韦　　　　　　韩\n  ```\n  ###\n  # pattern = /// (>>) (\\s*) ///g\n  pattern = /// (<<\\(keep-lines>>) (\\s*) ///g\n  R = text\n  #.........................................................................................................\n  # for pattern in @region_patterns\n  R = R.replace pattern, ( _, anchor, sws ) =>\n    id      = @_register_content S, 'sws', sws, sws\n    return \"#{anchor}\\x15#{id}\\x13\"\n  #.........................................................................................................\n  return R\n\n#-----------------------------------------------------------------------------------------------------------\n@escape.html_comments = ( S, text ) =>\n  R = text\n  #.........................................................................................................\n  for pattern in @html_comment_patterns\n    R = R.replace pattern, ( _, content ) =>\n      key = @_register_content S, 'comment', null, content, content.trim()\n      return \"\\x15#{key}\\x13\"\n  #.........................................................................................................\n  return R\n\n#-----------------------------------------------------------------------------------------------------------\n@escape.bracketed_raw_macros = ( S, text ) =>\n  R = text\n  #.........................................................................................................\n  for pattern in @bracketed_raw_patterns\n    R = R.replace pattern, ( _, markup, content ) =>\n      id = @_register_content S, 'raw', markup, content\n      return \"\\x15#{id}\\x13\"\n  #.........................................................................................................\n  return R\n\n#-----------------------------------------------------------------------------------------------------------\n@escape.action_macros = ( S, text ) =>\n  R = text\n  #.........................................................................................................\n  for pattern in @action_patterns\n    R = R.replace pattern, ( _, markup, identifier, content, stopper ) =>\n      mode      = if markup is '.' then 'silent' else 'vocal'\n      language  = identifier\n      language  = 'coffee' if language is ''\n      ### TAINT not using arguments peoperly ###\n      id        = @_register_content S, 'action', [ mode, language, ], content\n      return \"\\x15#{id}\\x13\"\n  #.........................................................................................................\n  return R\n\n#-----------------------------------------------------------------------------------------------------------\n@escape.insert_macros = ( S, text ) =>\n  R = text\n  #.........................................................................................................\n  for pattern in @insert_command_patterns\n    R = R.replace pattern, ( _, markup, parameter_txt ) =>\n      [ error_message, result, ] = MKTS.MACRO_INTERPRETER._parameters_from_text S, 0, parameter_txt\n      ### TAINT need current context to resolve file route ###\n      ### TAINT how to return proper error message? ###\n      ### TAINT what kind of error handling is this? ###\n      if result?\n        [ route, ] = result\n        if route?\n          try\n            content = njs_fs.readFileSync route, encoding: 'utf-8'\n          catch error\n            error_message = ( error_message ? '' ) + \"\\n\" + error[ 'message' ]\n        else\n          error_message = ( error_message ? '' ) + \"\\nneed file route for insert macro\"\n      if error_message?\n        return \" XXXXXXXX #{error_message} XXXXXXXX \"\n      return content\n  #.........................................................................................................\n  return R\n\n#-----------------------------------------------------------------------------------------------------------\n@escape.region_macros = ( S, text ) =>\n  R = text\n  #.........................................................................................................\n  for pattern in @region_patterns\n    R = R.replace pattern, ( _, start_markup, identifier, stop_markup ) =>\n      markup  = if start_markup.length is 0 then stop_markup else start_markup\n      id      = @_register_content S, 'region', markup, identifier\n      if identifier is 'keep-lines'\n        if start_markup is '('\n          return \"\"\"\n            \\x15#{id}\\x13\n            ```keep-lines\"\"\"\n        else\n          return \"\"\"\n            ```\n            \\x15#{id}\\x13\"\"\"\n      return \"\\x15#{id}\\x13\"\n  #.........................................................................................................\n  return R\n\n#-----------------------------------------------------------------------------------------------------------\n@escape.comma_macros = ( S, text ) =>\n  R = text\n  #.........................................................................................................\n  for pattern in @comma_patterns\n    R = R.replace pattern, ( _ ) =>\n      # debug '©ΛΨ regions', ( rpr text ), [ previous_chr, markup, identifier, content, stopper, ]\n      id      = @_register_content S, 'comma', null, null\n      return \"\\x15#{id}\\x13\"\n  #.........................................................................................................\n  return R\n\n#-----------------------------------------------------------------------------------------------------------\n@escape.command_and_value_macros = ( S, text ) =>\n  R = text\n  #.........................................................................................................\n  for pattern in @command_and_value_patterns\n    R = R.replace pattern, ( _, markup, content ) =>\n      kind            = if markup is '!' then 'command' else 'value'\n      key             = @_register_content S, kind, markup, content, null\n      return \"\\x15#{key}\\x13\"\n  #.........................................................................................................\n  return R\n\n\n#===========================================================================================================\n# EXPANDING\n#-----------------------------------------------------------------------------------------------------------\n@raw_id_pattern = ///\n  \\x15 raw ( [ 0-9 ]+ ) \\x13\n  ///g\n\n#-----------------------------------------------------------------------------------------------------------\n@html_comment_id_pattern = ///\n  \\x15 comment ( [ 0-9 ]+ ) \\x13\n  ///g\n\n#-----------------------------------------------------------------------------------------------------------\n@action_id_pattern = ///\n  \\x15 action ( [ 0-9 ]+ ) \\x13\n  ///g\n\n#-----------------------------------------------------------------------------------------------------------\n@region_id_pattern = ///\n  \\x15 region ( [ 0-9 ]+ ) \\x13\n  ///g\n\n#-----------------------------------------------------------------------------------------------------------\n@comma_id_pattern = ///\n  \\x15 comma ( [ 0-9 ]+ ) \\x13\n  ///g\n\n#-----------------------------------------------------------------------------------------------------------\n@sws_id_pattern = ///\n  \\x15 sws ( [ 0-9 ]+ ) \\x13\n  ///g\n\n#-----------------------------------------------------------------------------------------------------------\n@command_and_value_id_pattern = ///\n  \\x15 (?: command | value ) ( [ 0-9 ]+ ) \\x13\n  ///g\n\n\n#===========================================================================================================\n# EXPANDERS\n#-----------------------------------------------------------------------------------------------------------\n@$expand = ( S ) ->\n  pipeline = [\n    @$expand.$command_and_value_macros  S\n    @$expand.$comma_macros              S\n    @$expand.$region_macros             S\n    @$expand.$action_macros             S\n    @$expand.$raw_macros                S\n    @$expand.$sensitive_ws              S\n    @$expand.$html_comments             S\n    @$expand.$escape_chrs               S\n    # @$expand.$escape_illegals           S\n    ]\n  #.......................................................................................................\n  settings =\n    # inputs:\n    #   mktscript:        mktscript_in\n    # outputs:\n    #   mktscript:        mktscript_out\n    S:                S\n  #.......................................................................................................\n  return D.TEE.from_pipeline pipeline, settings\n\n#-----------------------------------------------------------------------------------------------------------\n@$expand.$html_comments = ( S ) =>\n  return @_get_expander S, @html_comment_id_pattern, ( meta, entry ) =>\n    content       = entry[ 'raw' ]\n    return [ '.', 'comment', content, ( MKTS.MD_READER.copy meta ), ]\n\n#-----------------------------------------------------------------------------------------------------------\n@$expand.$raw_macros  = ( S ) =>\n  return @_get_expander S, @raw_id_pattern, ( meta, entry ) =>\n    content       = entry[ 'raw' ]\n    return [ '.', 'raw', content, ( MKTS.MD_READER.copy meta ), ]\n\n#-----------------------------------------------------------------------------------------------------------\n@$expand.$action_macros  = ( S ) =>\n  return @_get_expander S, @action_id_pattern, ( meta, entry ) =>\n    [ mode\n      language ]  = entry[ 'markup' ]\n    content       = entry[ 'raw' ]\n    # debug '©19694', rpr content\n    return [ '.', 'action', content, ( MKTS.MD_READER.copy meta, { mode, language, } ), ]\n\n#-----------------------------------------------------------------------------------------------------------\n@$expand.$comma_macros  = ( S ) =>\n  return @_get_expander S, @comma_id_pattern, ( meta, entry ) =>\n    return [ '.', 'comma', null, ( MKTS.MD_READER.copy meta, ), ]\n\n#-----------------------------------------------------------------------------------------------------------\n@$expand.$sensitive_ws  = ( S ) =>\n  return @_get_expander S, @sws_id_pattern, ( meta, entry ) =>\n    return [ '.', 'text', entry[ 'raw' ], ( MKTS.MD_READER.copy meta, ), ]\n\n#-----------------------------------------------------------------------------------------------------------\n@$expand.$region_macros = ( S ) =>\n  return @_get_expander S, @region_id_pattern, ( meta, entry ) =>\n    { raw\n      markup }    = entry\n    return [ markup, raw, null, ( MKTS.MD_READER.copy meta ), ]\n\n#-----------------------------------------------------------------------------------------------------------\n@$expand.$command_and_value_macros = ( S ) =>\n  return @_get_expander S, @command_and_value_id_pattern, ( meta, entry ) =>\n    { raw\n      markup }    = entry\n    # macro_type    = if markup is '!' then 'command' else 'value'\n    return [ markup, raw, null, ( MKTS.MD_READER.copy meta ), ]\n\n#-----------------------------------------------------------------------------------------------------------\n@$expand.$escape_chrs = ( S ) =>\n  return $ ( event, send ) =>\n    #.......................................................................................................\n    if MKTS.MD_READER.select event, '.', 'text'\n      [ type, name, text, meta, ] = event\n      # debug '9573485', rpr text\n      # debug '9573485', rpr @escape.unescape_escape_chrs S, text\n      send [ type, name, ( @escape.unescape_escape_chrs S, text ), meta, ]\n    #.......................................................................................................\n    else\n      send event\n\n#-----------------------------------------------------------------------------------------------------------\n@$expand.$remove_backslashes = ( S ) =>\n  return $ ( event, send ) =>\n    #.......................................................................................................\n    if MKTS.MD_READER.select event, '.', 'text'\n      [ type, name, text, meta, ] = event\n      # debug '83457', rpr text\n      # debug '83457', rpr @escape.remove_escaping_backslashes S, text\n      send [ type, name, ( @escape.remove_escaping_backslashes S, text ), meta, ]\n    #.......................................................................................................\n    else\n      send event\n\n#-----------------------------------------------------------------------------------------------------------\n@$expand.$escape_illegals = ( S ) =>\n  return $ ( event, send ) =>\n    #.......................................................................................................\n    if MKTS.MD_READER.select event, '.', 'text'\n      [ type, name, text, meta, ] = event\n      # debug '©38889', rpr text\n      #.....................................................................................................\n      for pattern in @illegal_patterns\n        stretches = []\n        #...................................................................................................\n        for raw_stretch, idx in text.split pattern\n          if ( idx % 3 ) is 1 then  stretches[ stretches.length - 1 ] += raw_stretch\n          else                      stretches.push raw_stretch\n        #...................................................................................................\n        is_plain  = yes\n        for stretch in stretches\n          is_plain = not is_plain\n          debug '©10012', ( if is_plain then CND.green else CND.red ) rpr stretch\n          unless is_plain\n            { line_nr }   = meta\n            error_message = \"illegal macro pattern on line #{line_nr}: #{rpr stretch}\"\n            send [ '.', 'warning', error_message, ( MKTS.MD_READER.copy meta ), ]\n          else\n            send [ type, name, stretch, ( MKTS.MD_READER.copy meta ), ] unless stretch.length is 0\n    #.......................................................................................................\n    else\n      send event\n\n\n#===========================================================================================================\n# GENERIC EXPANDER\n#-----------------------------------------------------------------------------------------------------------\n@_get_expander = ( S, pattern, method ) =>\n  return $ ( event, send ) =>\n    #.......................................................................................................\n    if MKTS.MD_READER.select event, '.', 'text'\n      is_plain                    = no\n      [ type, name, text, meta, ] = event\n      for stretch in text.split pattern\n        is_plain = not is_plain\n        unless is_plain\n          id    = parseInt stretch, 10\n          entry = @_retrieve_entry S, id\n          send method meta, entry\n        else\n          send [ type, name, stretch, ( MKTS.MD_READER.copy meta ), ] unless stretch.length is 0\n    #.......................................................................................................\n    else\n      send event\n\n\n\n\n\n"]}