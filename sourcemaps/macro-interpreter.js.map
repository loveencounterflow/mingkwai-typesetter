{"version":3,"sources":["macro-interpreter.coffee"],"names":[],"mappings":"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","file":"macro-interpreter.js","sourceRoot":"/source/","sourcesContent":["\n\n\n\n############################################################################################################\n# njs_path                  = require 'path'\n# njs_fs                    = require 'fs'\n#...........................................................................................................\nCND                       = require 'cnd'\nrpr                       = CND.rpr\nbadge                     = 'MKTS/MACROS'\nlog                       = CND.get_logger 'plain',     badge\ninfo                      = CND.get_logger 'info',      badge\nwhisper                   = CND.get_logger 'whisper',   badge\nalert                     = CND.get_logger 'alert',     badge\ndebug                     = CND.get_logger 'debug',     badge\nwarn                      = CND.get_logger 'warn',      badge\nhelp                      = CND.get_logger 'help',      badge\nurge                      = CND.get_logger 'urge',      badge\necho                      = CND.echo.bind CND\n#-----------------------------------------------------------------------------------------------------------\nD                         = require 'pipedreams'\n$                         = D.remit.bind D\n# $async                    = D.remit_async.bind D\n#...........................................................................................................\n# Markdown_parser           = require 'markdown-it'\n# # Html_parser               = ( require 'htmlparser2' ).Parser\n# new_md_inline_plugin      = require 'markdown-it-regexp'\n#...........................................................................................................\n# HELPERS                   = require './HELPERS'\n#...........................................................................................................\n# misfit                    = Symbol 'misfit'\nMKTS                      = require './main'\n\n\n#===========================================================================================================\n#\n#-----------------------------------------------------------------------------------------------------------\n@$process_actions = ( S ) =>\n  ### TAINT this is an essentially synchronous solution that will not work for async code ###\n  copy  = MKTS.MD_READER.copy.bind  MKTS.MD_READER\n  stamp = MKTS.MD_READER.stamp.bind MKTS.MD_READER\n  hide  = MKTS.MD_READER.hide.bind  MKTS.MD_READER\n  #.........................................................................................................\n  CS                        = require 'coffee-script'\n  VM                        = require 'vm'\n  local_filename            = 'XXXXXXXXXXXXX'\n  macro_output              = []\n  #.........................................................................................................\n  do =>\n    S.compiled          = {}\n    S.compiled.coffee   = {}\n    S.sandbox           =\n      'rpr':            CND.rpr\n      urge:             CND.get_logger 'urge', local_filename\n      help:             CND.get_logger 'help', local_filename\n      setImmediate:     setImmediate\n      echo:             ( P... ) -> macro_output.push CND.pen P...\n      mkts:\n        output:           macro_output\n        reserved_names:   []\n        __filename:       local_filename\n    S.sandbox[ 'here' ] = S.sandbox\n    for name of S.sandbox\n      S.sandbox.mkts.reserved_names.push name\n    VM.createContext S.sandbox\n  #.........................................................................................................\n  return $ ( event, send ) =>\n    if MKTS.MD_READER.select event, '.', 'action'\n      [ _, _, raw_source, meta, ]     = event\n      send stamp hide event\n      { mode, language, line_nr, }    = meta\n      error_message                   = null\n      #.....................................................................................................\n      switch language\n        when 'js'\n          js_source = raw_source\n        when 'coffee'\n          unless ( js_source = S.compiled.coffee[ raw_source ] )?\n            wrapped_source  = \"do =>\\n  \" + raw_source.replace /\\n/g, \"\\n  \"\n            try\n              js_source     = CS.compile wrapped_source, { bare: true, filename: local_filename, }\n            catch error\n              error_message = error[ 'message' ] ? rpr error\n            unless error_message?\n              S.compiled.coffee[ raw_source ] = js_source\n        else\n          error_message = \"unknown language #{rpr language}\"\n      #.....................................................................................................\n      try\n        action_value = VM.runInContext js_source, S.sandbox, { filename: local_filename, }\n      #.....................................................................................................\n      catch error\n        error_message = error[ 'message' ] ? rpr error\n      #.....................................................................................................\n      if error_message?\n        warn error_message\n        ### TAINT should preserve stack trace of error ###\n        ### TAINT use method to assemble warning event ###\n        ### TAINT write error log with full trace, insert reference (error nr) ###\n        error_message = \"action on line #{line_nr}: #{error_message}\"\n        send [ '.', 'warning', error_message, ( copy meta ), ]\n      #.....................................................................................................\n      else\n        ### TAINT join using empty string? spaces? newlines? ###\n        if macro_output.length > 0\n          macro_output_rpr    = macro_output.join ''\n          macro_output.length = 0\n          send [ '.', 'text', macro_output_rpr, ( copy meta ), ]\n        #.....................................................................................................\n        switch mode\n          when 'silent'\n            null\n          when 'vocal'\n            ### TAINT send `tex` or `text`??? ###\n            action_value_rpr = if CND.isa_text action_value then action_value else rpr action_value\n            send [ '.', 'text', action_value_rpr, ( copy meta ), ]\n    #.......................................................................................................\n    else\n      send event\n\n        # # for sub_name, sub_value of S.sandbox\n        # #   continue if sub_name in S.sandbox.mkts.reserved_names\n        # #   S.sandbox.mkts.definitions[ sub_name ] = sub_value\n        # #.....................................................................................................\n        # do =>\n        #   # debug '©Y action: source:    ', rpr source\n        #   # debug '©Y action: js_source: ', rpr js_source\n        #   # debug '©Y action: language:  ', rpr language\n        #   # debug '©Y action: mode:      ', rpr mode\n        #   # debug '©Y action: S.sandbox: ', rpr S.sandbox\n        #   debug '©Y action: value:     ', rpr action_value\n        #   for name, value of S.sandbox\n        #     whisper \"#{name}: #{rpr value}\"\n\n#-----------------------------------------------------------------------------------------------------------\n@$process_values = ( S ) =>\n  copy  = MKTS.MD_READER.copy.bind  MKTS.MD_READER\n  stamp = MKTS.MD_READER.stamp.bind MKTS.MD_READER\n  hide  = MKTS.MD_READER.hide.bind  MKTS.MD_READER\n  #.........................................................................................................\n  throw new Error \"internal error: need S.sandbox, must use `$process_actions`\" unless S.sandbox?\n  #.........................................................................................................\n  return $ ( event, send ) =>\n    if MKTS.MD_READER.select event, '.', 'value'\n      [ _, _, identifier, meta, ]     = event\n      action_value                    = S.sandbox[ identifier ]\n      unless action_value is undefined\n        action_value_rpr = rpr action_value unless CND.isa_text action_value\n        send [ '.', 'text', action_value_rpr, ( copy meta ), ]\n      else\n        ### TAINT should preserve stack trace of error ###\n        ### TAINT use method to assemble warning event ###\n        ### TAINT write error log with full trace, insert reference (error nr) ###\n        { line_nr, }  = meta\n        error_message = \"value on line #{line_nr}: unknown identifier #{rpr identifier}\"\n        send [ '.', 'warning', error_message, ( copy meta ), ]\n    #.......................................................................................................\n    else\n      send event\n\n# #-----------------------------------------------------------------------------------------------------------\n# @MKTX.COMMAND.$expansion = ( S ) =>\n#   remark = MD_READER._get_remark()\n#   #.........................................................................................................\n#   return $ ( event, send ) =>\n#     if MKTS.MD_READER.select event, '!'\n#       [ type, identifier, _, meta, ] = event\n#       if ( definition = S.local.definitions.get identifier )?\n#         # send stamp hide event\n#         send stamp hide [ '(', '!', identifier, ( copy meta ), ]\n#         # send copy sub_event for sub_event in definition\n#         # debug '@16', rpr definition\n#         send remark 'resend', \"expanding `#{identifier}`\", ( copy meta )\n#         S.resend definition # [ '.', 'text', definition, ( copy meta ), ]\n#         send stamp hide [ ')', '!', identifier, ( copy meta ), ]\n#       else\n#         send event\n#     #.......................................................................................................\n#     else\n#       send event\n"]}